================================================================================
DIAGN√ìSTICO COMPLETO: RELOJ DE MEDITACI√ìN Y RECURSOS T√âCNICOS
================================================================================
Fecha: $(date)
Estado: ERROR DE SINTAXIS - Servidor no inicia

================================================================================
1. OBJETIVO DEL PROYECTO
================================================================================

Implementar un sistema de "Reloj de Meditaci√≥n" con las siguientes caracter√≠sticas:

A. RELOJ DE MEDITACI√ìN (Cliente)
   - Aparece en las p√°ginas de "Preparaci√≥n para la pr√°ctica" y "T√©cnicas Post-pr√°ctica"
   - Solo se muestra si est√° activado en el admin para ese √≠tem espec√≠fico
   - Configuraci√≥n:
     * Tiempo configurable hasta 120 minutos (solo antes de iniciar)
     * Opci√≥n de reproducir m√∫sica de meditaci√≥n (s√≠/no)
     * M√∫sica por defecto configurada por admin en cada √≠tem
     * La m√∫sica debe hacer loop autom√°tico si es m√°s corta que el tiempo configurado
     * La m√∫sica debe sonar incluso con el tel√©fono bloqueado
   - Funcionalidades:
     * Mostrar tiempo transcurrido y tiempo restante
     * Botones: Pausar, Reanudar, Reiniciar (pero NO cambiar tiempo durante meditaci√≥n)
     * Al finalizar: reproducir un tono caracter√≠stico
     * El tono se reproduce una vez (no se puede detener)
     * Persistencia: el reloj contin√∫a funcionando si se cambia de pesta√±a o minimiza
     * Guardar configuraci√≥n (tiempo, m√∫sica seleccionada) para pr√≥xima sesi√≥n
   - Tono final:
     * Hay un tono por defecto
     * El usuario puede configurar tonos personalizados en su perfil de alumno (tab personal)

B. RECURSOS T√âCNICOS (Admin)
   - Nueva secci√≥n en admin: "Recursos t√©cnicos para las pr√°cticas"
   - Dos subsecciones:
     1. "M√∫sicas de meditaci√≥n" - Banco de m√∫sicas disponibles para todo el servidor
     2. "Tonos de meditaci√≥n" - Banco de tonos disponibles para todo el servidor
   - Funcionalidades:
     * Subida de archivos (MP3, WAV, OGG, todos los formatos posibles)
     * URLs externas como alternativa a archivos
     * Sin l√≠mite de tama√±o de archivo
     * Campos: nombre, descripci√≥n, categor√≠a, archivo/URL, duraci√≥n (segundos), peso (MB)
     * Para tonos: campo adicional "es_por_defecto" (checkbox)
     * Edici√≥n inline en tablas
     * Creaci√≥n r√°pida
     * Eliminaci√≥n

C. INTEGRACI√ìN CON PREPARACIONES Y T√âCNICAS POST-PR√ÅCTICA
   - En los admin panels de "Preparaci√≥n para la pr√°ctica" y "T√©cnicas Post-pr√°ctica":
     * Nuevo campo: "Activar reloj de meditaci√≥n" (checkbox)
     * Nuevo campo: "M√∫sica de meditaci√≥n por defecto" (dropdown con m√∫sicas disponibles)

================================================================================
2. ARCHIVOS CREADOS/MODIFICADOS
================================================================================

A. BASE DE DATOS
   Archivo: database/pg.js
   Cambios:
   - Agregadas columnas a tabla `preparaciones_practica`:
     * activar_reloj (BOOLEAN, default false)
     * musica_meditacion_id (INTEGER, foreign key a musicas_meditacion)
   - Agregadas columnas a tabla `tecnicas_post_practica`:
     * activar_reloj (BOOLEAN, default false)
     * musica_meditacion_id (INTEGER, foreign key a musicas_meditacion)
   - Creada tabla `musicas_meditacion`:
     * id (SERIAL PRIMARY KEY)
     * nombre (VARCHAR(255) NOT NULL)
     * descripcion (TEXT)
     * categoria (VARCHAR(100))
     * archivo_path (VARCHAR(500))
     * url_externa (VARCHAR(500))
     * duracion_segundos (INTEGER)
     * peso_mb (DECIMAL(10,2))
     * es_por_defecto (BOOLEAN, default false) - NO SE USA, solo para tonos
     * activo (BOOLEAN, default true)
     * created_at (TIMESTAMP)
     * updated_at (TIMESTAMP)
   - Creada tabla `tonos_meditacion`:
     * id (SERIAL PRIMARY KEY)
     * nombre (VARCHAR(255) NOT NULL)
     * descripcion (TEXT)
     * categoria (VARCHAR(100))
     * archivo_path (VARCHAR(500))
     * url_externa (VARCHAR(500))
     * duracion_segundos (INTEGER)
     * peso_mb (DECIMAL(10,2))
     * es_por_defecto (BOOLEAN, default false) - IMPORTANTE: solo uno puede ser true
     * activo (BOOLEAN, default true)
     * created_at (TIMESTAMP)
     * updated_at (TIMESTAMP)

B. SERVICIOS (Services Layer)
   Archivos creados:
   1. src/services/musicas-meditacion.js
      - listarMusicas()
      - obtenerMusica(id)
      - crearMusica(datos)
      - actualizarMusica(id, datos)
      - eliminarMusica(id)
   
   2. src/services/tonos-meditacion.js
      - listarTonos()
      - obtenerTono(id)
      - crearTono(datos)
      - actualizarTono(id, datos)
      - eliminarTono(id)
   
   Archivos modificados:
   3. src/services/preparaciones-practica.js
      - Actualizado crearPreparacion() para incluir activar_reloj y musica_meditacion_id
      - Actualizado actualizarPreparacion() para incluir activar_reloj y musica_meditacion_id
   
   4. src/services/tecnicas-post-practica.js
      - Actualizado crearTecnicaPostPractica() para incluir activar_reloj y musica_meditacion_id
      - Actualizado actualizarTecnicaPostPractica() para incluir activar_reloj y musica_meditacion_id

C. API ENDPOINTS
   Archivos creados:
   1. src/endpoints/musicas-meditacion-api.js
      - GET /api/musicas-meditacion (listar todas)
      - GET /api/musicas-meditacion/:id (obtener una)
      - POST /api/musicas-meditacion (crear)
      - PUT /api/musicas-meditacion/:id (actualizar)
      - DELETE /api/musicas-meditacion/:id (eliminar)
   
   2. src/endpoints/tonos-meditacion-api.js
      - GET /api/tonos-meditacion (listar todas)
      - GET /api/tonos-meditacion/:id (obtener una)
      - POST /api/tonos-meditacion (crear)
      - PUT /api/tonos-meditacion/:id (actualizar)
      - DELETE /api/tonos-meditacion/:id (eliminar)
   
   3. src/endpoints/musicas-tonos-upload.js
      - POST /api/musicas-meditacion/upload (subir archivo de m√∫sica)
      - POST /api/tonos-meditacion/upload (subir archivo de tono)
      - Usa busboy para parsear multipart/form-data
      - Guarda archivos en /public/uploads/
      - Retorna: archivo_path (URL p√∫blica), duracion_segundos, peso_mb
      - NOTA: La duraci√≥n se calcula usando una librer√≠a de audio (pendiente de implementar)
   
   4. src/endpoints/admin-recursos-tecnicos.js ‚ö†Ô∏è PROBLEMA AQU√ç
      - GET /admin/recursos-tecnicos/musicas (panel admin m√∫sicas)
      - GET /admin/recursos-tecnicos/tonos (panel admin tonos)
      - Renderiza HTML con tablas inline editables
      - Incluye JavaScript para:
        * Creaci√≥n r√°pida
        * Edici√≥n inline (onblur)
        * Subida de archivos
        * Eliminaci√≥n
      - ‚ö†Ô∏è ERROR: SyntaxError: Invalid or unexpected token
      - ‚ö†Ô∏è CAUSA: Uso de &quot; (entidad HTML) dentro de template literals de JavaScript
      - ‚ö†Ô∏è ESTADO: Servidor no inicia debido a este error

D. ROUTING
   Archivo modificado: src/router.js
   Cambios:
   - Agregadas rutas para APIs de m√∫sicas y tonos
   - Agregadas rutas para upload de archivos
   - Agregada ruta para admin-recursos-tecnicos.js

   Archivo modificado: src/endpoints/admin-panel-v4.js
   Cambios:
   - Agregada importaci√≥n de admin-recursos-tecnicos.js
   - Agregada ruta /admin/recursos-tecnicos/*

E. MEN√ö ADMIN
   Archivo modificado: src/core/html/admin/base.html
   Cambios:
   - Agregado √≠tem de men√∫ "Recursos t√©cnicos para las pr√°cticas"
   - Ubicado bajo "Contenido PDE"
   - Link: /admin/recursos-tecnicos/musicas

F. SCRIPTS SQL
   Archivo creado: scripts/crear-tablas-musicas-tonos.sql
   - Script manual para crear tablas si es necesario
   - Incluye √≠ndices

================================================================================
3. ERRORES ENCONTRADOS Y CORRECCIONES INTENTADAS
================================================================================

ERROR PRINCIPAL: SyntaxError: Invalid or unexpected token
Archivo: src/endpoints/admin-recursos-tecnicos.js

PROBLEMA:
El archivo usa template literals de JavaScript (backticks `) para generar HTML.
Dentro de estos template literals, hay atributos HTML que contienen JavaScript inline
(como onclick, onchange, onblur, onkeydown).

El problema es que se us√≥ la entidad HTML &quot; en lugar de comillas simples o dobles
directas. Node.js no interpreta &quot; como una comilla, causando errores de sintaxis.

L√çNEAS PROBLEM√ÅTICAS IDENTIFICADAS Y CORREGIDAS:
- L√≠nea 89-95: onkeydown con comillas simples corregidas
- L√≠nea 99: onchange con &quot; corregido a comillas simples
- L√≠nea 100: onclick con &quot; corregido a comillas simples
- L√≠nea 101: onkeydown corregido
- L√≠nea 118-136: onblur con &quot; corregidos a comillas simples
- L√≠nea 130: onchange corregido
- L√≠nea 131: onclick corregido
- L√≠nea 182-194: onkeydown y onchange corregidos
- L√≠nea 211-232: onchange y onblur corregidos
- L√≠nea 226-227: onchange y onclick corregidos
- L√≠nea 366-367: getElementById con comillas corregidas
- L√≠nea 378: alert con comillas corregidas
- L√≠nea 396-401: getElementById con comillas corregidas
- L√≠nea 413: alert corregido
- L√≠nea 423: subirArchivo corregido
- L√≠nea 458: getElementById corregido
- L√≠nea 471: alert corregido
- L√≠nea 505: alert corregido
- L√≠nea 532: alert corregido (hab√≠a comilla simple mal cerrada)
- L√≠nea 555: alert corregido
- L√≠nea 583: alert corregido (hab√≠a comilla simple mal cerrada)
- L√≠nea 585: comparaci√≥n de string corregida
- L√≠nea 604: alert corregido
- L√≠nea 621: alert corregido

CORRECCIONES APLICADAS:
1. Reemplazo de &quot; por comillas simples (') en atributos HTML
2. Cambio de onkeydown='if(event.key === "Enter")' a onkeydown="if(event.key === 'Enter')"
3. Cambio de document.getElementById(&quot;...&quot;) a document.getElementById('...')
4. Correcci√≥n de alert("Error: ' + ...) a alert("Error: " + ...)
5. Correcci√≥n de template literals anidados usando concatenaci√≥n de strings

ESTADO ACTUAL:
- A pesar de todas las correcciones, el error persiste
- node --check no muestra errores (exit code 0)
- Pero node --input-type=module muestra "Invalid or unexpected token"
- El servidor PM2 no inicia correctamente
- HTTP Status: 000 (no hay respuesta del servidor)

POSIBLES CAUSAS PENDIENTES:
1. Caracteres especiales invisibles (UTF-8 BOM, espacios no-breaking, etc.)
2. Template literals anidados que no se detectaron
3. Comillas mal balanceadas en alguna parte del archivo
4. Problemas con emojis (üîó, üåê, üìÅ, etc.) dentro de strings
5. Backticks escapados incorrectamente

================================================================================
4. FUNCIONALIDADES PENDIENTES DE IMPLEMENTAR
================================================================================

A. RELOJ DE MEDITACI√ìN (Cliente)
   ‚ùå NO IMPLEMENTADO
   - Componente HTML/JavaScript para el reloj
   - L√≥gica de temporizador con persistencia
   - Integraci√≥n con Web Audio API para m√∫sica en background
   - Loop autom√°tico de m√∫sica
   - Reproducci√≥n de tono al finalizar
   - Guardado de configuraci√≥n en localStorage
   - Persistencia cuando se cambia de pesta√±a

B. INTEGRACI√ìN EN PREPARACIONES Y T√âCNICAS POST-PR√ÅCTICA
   ‚ùå NO IMPLEMENTADO
   - Campos en admin panels para activar_reloj y musica_meditacion_id
   - Dropdown para seleccionar m√∫sica de meditaci√≥n
   - L√≥gica en p√°ginas del cliente para mostrar el reloj si est√° activado

C. CONFIGURACI√ìN DE TONOS EN PERFIL DE ALUMNO
   ‚ùå NO IMPLEMENTADO
   - Tab personal en perfil de alumno
   - Selector de tono personalizado
   - Guardado de preferencia de tono

D. C√ÅLCULO DE DURACI√ìN DE AUDIO
   ‚ùå NO IMPLEMENTADO
   - La subida de archivos no calcula la duraci√≥n real
   - Necesita librer√≠a como node-ffmpeg o similar
   - Actualmente duracion_segundos debe ingresarse manualmente

================================================================================
5. ESTRUCTURA DEL ARCHIVO PROBLEM√ÅTICO
================================================================================

Archivo: src/endpoints/admin-recursos-tecnicos.js
L√≠neas totales: ~642

ESTRUCTURA:
1. Imports (l√≠neas 1-13)
2. Funci√≥n replace() (l√≠neas 15-23)
3. Funci√≥n principal adminRecursosTecnicosHandler() (l√≠neas 25-639)
   a. Autenticaci√≥n (l√≠neas 26-30)
   b. Determinaci√≥n de secci√≥n (l√≠neas 32-36)
   c. Carga de datos (l√≠neas 38-49)
   d. Template literal principal `content` (l√≠neas 51-628)
      - HTML est√°tico (l√≠neas 52-63)
      - Template literal condicional ${seccion === "musicas" ? `...` : `...`}
        * Secci√≥n m√∫sicas (l√≠neas 65-153)
        * Secci√≥n tonos (l√≠neas 154-250)
      - JavaScript inline (l√≠neas 253-627)
        * Variables y funciones para m√∫sicas
        * Variables y funciones para tonos
   e. Return Response (l√≠neas 630-638)

PROBLEMA ESPEC√çFICO:
El template literal principal (l√≠nea 51) contiene:
- HTML con atributos que tienen JavaScript inline
- Template literals anidados (l√≠neas 65, 115, 208)
- Strings JavaScript dentro de atributos HTML

EJEMPLO DE C√ìDIGO PROBLEM√ÅTICO (ANTES):
```
<input onchange="handleFileSelect(&quot;musica&quot;, this)">
```

EJEMPLO DE C√ìDIGO CORREGIDO (DESPU√âS):
```
<input onchange="handleFileSelect('musica', this)">
```

PERO EL ERROR PERSISTE, lo que sugiere:
1. Hay m√°s instancias de &quot; que no se encontraron
2. Hay problemas con template literals anidados
3. Hay caracteres especiales que causan problemas

================================================================================
6. COMANDOS √öTILES PARA DIAGN√ìSTICO
================================================================================

# Verificar sintaxis
node --check src/endpoints/admin-recursos-tecnicos.js

# Intentar importar el m√≥dulo
node --input-type=module -e "import('./src/endpoints/admin-recursos-tecnicos.js').then(() => console.log('OK')).catch(e => console.error('Error:', e.message))"

# Buscar todas las instancias de &quot;
grep -n '&quot;' src/endpoints/admin-recursos-tecnicos.js

# Buscar template literals anidados
grep -n '\${.*`.*`' src/endpoints/admin-recursos-tecnicos.js

# Ver logs del servidor
pm2 logs aurelinportal --lines 20

# Reiniciar servidor
pm2 restart aurelinportal --update-env

# Verificar estado
pm2 status

# Probar endpoint
curl -I http://localhost:3000/admin/recursos-tecnicos/musicas

================================================================================
7. RECOMENDACIONES PARA SOLUCIONAR EL ERROR
================================================================================

OPCI√ìN 1: Revisar manualmente el archivo
- Abrir src/endpoints/admin-recursos-tecnicos.js
- Buscar todas las instancias de &quot; y reemplazarlas
- Verificar que todas las comillas est√©n balanceadas
- Verificar que no haya template literals mal formados

OPCI√ìN 2: Usar un linter/formatter
- Instalar ESLint o Prettier
- Ejecutar sobre el archivo para detectar errores
- Aplicar correcciones autom√°ticas

OPCI√ìN 3: Reescribir el archivo
- Separar el HTML del JavaScript
- Usar funciones para generar HTML en lugar de template literals
- Usar un sistema de templates m√°s robusto

OPCI√ìN 4: Usar un enfoque diferente
- Generar el HTML usando un template engine (EJS, Handlebars, etc.)
- Separar el JavaScript en un archivo externo
- Cargar el JavaScript desde un archivo .js separado

================================================================================
8. ARCHIVOS RELACIONADOS QUE FUNCIONAN CORRECTAMENTE
================================================================================

‚úÖ database/pg.js - Sin errores aparentes
‚úÖ src/services/musicas-meditacion.js - Sin errores
‚úÖ src/services/tonos-meditacion.js - Sin errores
‚úÖ src/services/preparaciones-practica.js - Sin errores
‚úÖ src/services/tecnicas-post-practica.js - Sin errores
‚úÖ src/endpoints/musicas-meditacion-api.js - Sin errores
‚úÖ src/endpoints/tonos-meditacion-api.js - Sin errores
‚úÖ src/endpoints/musicas-tonos-upload.js - Sin errores
‚úÖ src/router.js - Sin errores
‚úÖ src/endpoints/admin-panel-v4.js - Sin errores
‚úÖ src/core/html/admin/base.html - Sin errores

‚ùå src/endpoints/admin-recursos-tecnicos.js - ERROR DE SINTAXIS

================================================================================
9. PR√ìXIMOS PASOS SUGERIDOS
================================================================================

1. SOLUCIONAR EL ERROR DE SINTAXIS (PRIORIDAD ALTA)
   - Sin esto, el servidor no puede iniciar
   - El panel admin de recursos t√©cnicos no es accesible
   - Bloquea todo el desarrollo posterior

2. IMPLEMENTAR C√ÅLCULO DE DURACI√ìN DE AUDIO
   - Instalar librer√≠a para leer metadatos de audio
   - Integrar en el endpoint de upload
   - Actualizar autom√°ticamente duracion_segundos

3. IMPLEMENTAR CAMPOS EN ADMIN DE PREPARACIONES Y T√âCNICAS
   - Agregar checkbox "Activar reloj"
   - Agregar dropdown "M√∫sica por defecto"
   - Actualizar servicios para guardar estos campos

4. IMPLEMENTAR RELOJ DE MEDITACI√ìN EN CLIENTE
   - Crear componente HTML/CSS/JS
   - Integrar con Web Audio API
   - Implementar persistencia
   - Implementar loop de m√∫sica
   - Implementar reproducci√≥n de tono

5. IMPLEMENTAR CONFIGURACI√ìN DE TONOS EN PERFIL
   - Crear tab en perfil de alumno
   - Selector de tono personalizado
   - Guardar preferencia en base de datos

================================================================================
10. NOTAS ADICIONALES
================================================================================

- El proyecto usa ES Modules (type: "module" en package.json)
- El servidor usa Node.js 18+
- Se usa PM2 para gesti√≥n de procesos
- El servidor corre en el puerto 3000
- Nginx act√∫a como proxy reverso
- La base de datos es PostgreSQL
- Los archivos se guardan en /public/uploads/

- El error de sintaxis es cr√≠tico porque impide que el servidor inicie
- Una vez solucionado, se podr√° acceder a /admin/recursos-tecnicos/musicas
- El resto de la funcionalidad depende de que este panel funcione

================================================================================
FIN DEL DIAGN√ìSTICO
================================================================================


























