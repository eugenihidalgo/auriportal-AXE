# ============================================================================
# Configuración Nginx para AuriPortal - Entornos DEV/BETA/PROD
# ============================================================================
# Este archivo contiene la configuración para los 3 entornos.
# 
# INSTRUCCIONES DE INSTALACIÓN:
# 1. Hacer backup de la configuración actual:
#    sudo cp /etc/nginx/sites-available/aurelinportal /etc/nginx/sites-available/aurelinportal.backup.$(date +%Y%m%d)
#
# 2. Copiar esta configuración:
#    sudo cp nginx-multi-env.conf /etc/nginx/sites-available/aurelinportal
#
# 3. Verificar sintaxis:
#    sudo nginx -t
#
# 4. Recargar Nginx:
#    sudo systemctl reload nginx
#
# 5. Configurar certificados SSL para los nuevos subdominios:
#    sudo certbot --nginx -d portal.pdeeugenihidalgo.org -d beta.portal.pdeeugenihidalgo.org -d dev.portal.pdeeugenihidalgo.org
# ============================================================================

# ============================================================================
# PRODUCCIÓN - portal.pdeeugenihidalgo.org
# ============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name portal.pdeeugenihidalgo.org;

    # Para verificación de Let's Encrypt (certbot)
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # Redirigir a HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name portal.pdeeugenihidalgo.org;

    # Certificados SSL (configurar con certbot)
    ssl_certificate /etc/letsencrypt/live/portal.pdeeugenihidalgo.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/portal.pdeeugenihidalgo.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Archivos estáticos de /uploads/
    location /uploads/ {
        alias /var/www/aurelinportal/public/uploads/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        
        types {
            image/jpeg jpg jpeg;
            image/png png;
            image/gif gif;
            image/webp webp;
            image/svg+xml svg;
        }
        
        try_files $uri =404;
    }
    
    # Proxy a aplicación Node.js (PRODUCCIÓN - puerto 3000)
    location / {
        client_max_body_size 100M;
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Logs específicos de producción
    access_log /var/log/nginx/aurelinportal-prod-access.log;
    error_log /var/log/nginx/aurelinportal-prod-error.log;
}

# ============================================================================
# BETA - beta.portal.pdeeugenihidalgo.org
# ============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name beta.portal.pdeeugenihidalgo.org;

    # Para verificación de Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # Redirigir a HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name beta.portal.pdeeugenihidalgo.org;

    # Certificados SSL (configurar con certbot)
    ssl_certificate /etc/letsencrypt/live/beta.portal.pdeeugenihidalgo.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/beta.portal.pdeeugenihidalgo.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Archivos estáticos de /uploads/
    location /uploads/ {
        alias /var/www/aurelinportal/public/uploads/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        
        types {
            image/jpeg jpg jpeg;
            image/png png;
            image/gif gif;
            image/webp webp;
            image/svg+xml svg;
        }
        
        try_files $uri =404;
    }
    
    # Proxy a aplicación Node.js (BETA - puerto 3002)
    location / {
        client_max_body_size 100M;
        proxy_pass http://127.0.0.1:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Logs específicos de beta
    access_log /var/log/nginx/aurelinportal-beta-access.log;
    error_log /var/log/nginx/aurelinportal-beta-error.log;
}

# ============================================================================
# DESARROLLO - dev.portal.pdeeugenihidalgo.org
# ============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name dev.portal.pdeeugenihidalgo.org;

    # Para verificación de Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # Redirigir a HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name dev.portal.pdeeugenihidalgo.org;

    # Certificados SSL (configurar con certbot)
    ssl_certificate /etc/letsencrypt/live/dev.portal.pdeeugenihidalgo.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dev.portal.pdeeugenihidalgo.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Archivos estáticos de /uploads/
    location /uploads/ {
        alias /var/www/aurelinportal/public/uploads/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        
        types {
            image/jpeg jpg jpeg;
            image/png png;
            image/gif gif;
            image/webp webp;
            image/svg+xml svg;
        }
        
        try_files $uri =404;
    }
    
    # Proxy a aplicación Node.js (DESARROLLO - puerto 3001)
    location / {
        client_max_body_size 100M;
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Logs específicos de desarrollo
    access_log /var/log/nginx/aurelinportal-dev-access.log;
    error_log /var/log/nginx/aurelinportal-dev-error.log;
}

# ============================================================================
# DOMINIOS LEGACY (mantener compatibilidad)
# ============================================================================
# Estos dominios redirigen a producción para mantener URLs existentes
server {
    listen 80;
    listen [::]:80;
    server_name pdeeugenihidalgo.org www.pdeeugenihidalgo.org;

    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    return 301 https://portal.pdeeugenihidalgo.org$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name pdeeugenihidalgo.org www.pdeeugenihidalgo.org;

    # Usar certificado existente o configurar con certbot
    ssl_certificate /etc/letsencrypt/live/pdeeugenihidalgo.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/pdeeugenihidalgo.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Redirigir a portal.pdeeugenihidalgo.org (producción)
    return 301 https://portal.pdeeugenihidalgo.org$request_uri;
}

# ============================================================================
# ADMIN (si aplica)
# ============================================================================
# Si necesitas un subdominio admin separado, descomenta esto:
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name admin.portal.pdeeugenihidalgo.org;
#
#     ssl_certificate /etc/letsencrypt/live/admin.portal.pdeeugenihidalgo.org/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/admin.portal.pdeeugenihidalgo.org/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#
#     location / {
#         proxy_pass http://127.0.0.1:3000;  # Mismo que producción
#         # ... misma configuración de proxy ...
#     }
# }












