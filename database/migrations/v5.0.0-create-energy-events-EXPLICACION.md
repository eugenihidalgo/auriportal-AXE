# Explicación Técnica: `energy_events` como Núcleo Canónico

## ¿Por qué esta tabla es el núcleo del sistema?

La tabla `energy_events` es la **columna vertebral** del sistema energético de AuriPortal porque implementa el patrón arquitectónico de **Event Sourcing** aplicado al dominio energético.

### 1. Inmutabilidad como Fundamento

**Problema resuelto**: Los sistemas legacy que modifican estados directamente tienen problemas de:
- Pérdida de historia (¿qué pasó antes?)
- Imposibilidad de auditar cambios
- Dificultad para debuggear ("¿por qué está en este estado?")
- Race conditions al actualizar estados

**Solución**: Cada evento es un **hecho histórico inmutable**. No se modifica, no se borra. El estado se **deriva** de la secuencia de eventos, no se almacena.

### 2. Extensibilidad Infinita

**Problema resuelto**: Los sistemas con esquemas rígidos requieren migraciones cada vez que se agrega un nuevo concepto.

**Solución**: Cualquier concepto energético nuevo (limpiar, iluminar, conectar, amar, activar, bendecir, etc.) es simplemente un nuevo `event_type`. No requiere cambios en el esquema. El campo `metadata` (JSONB) permite campos específicos sin migraciones.

**Ejemplo**: Para agregar "bendiciones", simplemente insertas eventos con `event_type='bendicion_aplicada'` y usas `metadata` para campos específicos. Cero cambios en la base de datos.

### 3. Single Source of Truth

**Problema resuelto**: Sistemas con múltiples tablas de estado (limpiezas, iluminaciones, conexiones) tienen problemas de:
- Sincronización entre tablas
- Inconsistencias cuando falla una actualización
- Complejidad de queries para obtener el estado completo

**Solución**: Una única tabla central. Todos los eventos energéticos van aquí. El estado se calcula leyendo eventos, garantizando consistencia.

### 4. Auditoría Total

**Problema resuelto**: Sistemas sin auditoría no pueden responder "¿quién hizo qué y cuándo?".

**Solución**: Cada evento tiene `actor_type`, `actor_id`, `occurred_at`, `origin`, `request_id`. Puedes rastrear cualquier cambio hasta su origen exacto.

### 5. Preparación para Escala

**Diseño para millones de registros**:
- `BIGSERIAL` permite hasta 9.2 quintillones de registros
- Índices optimizados para consultas comunes
- Estructura preparada para particionamiento futuro (por fecha o alumno_id)
- JSONB indexable para queries eficientes en metadata

### 6. Cálculo de Estado On-Demand

**Principio clave**: El estado NO se almacena, se **calcula**.

**Ventajas**:
- Siempre es correcto (no hay desincronización)
- Puedes "viajar en el tiempo" (¿cómo estaba el sistema el 1 de enero?)
- Permite múltiples "vistas" del mismo estado (diferentes reglas de cálculo)

**Ejemplo**: Para saber si un lugar está limpio:
```sql
SELECT is_clean_after 
FROM energy_events 
WHERE subject_type = 'lugar' 
  AND subject_id = '123'
  AND event_type LIKE 'limpieza_%'
ORDER BY occurred_at DESC 
LIMIT 1;
```

### 7. Correlación con Otros Sistemas

El campo `request_id` permite correlacionar eventos con:
- `audit_events` (auditoría del Master)
- `analytics_events` (analytics del sistema)
- Logs del servidor
- Requests HTTP

Esto permite trazabilidad completa de extremo a extremo.

## Comparación con el Sistema Legacy

| Aspecto | Sistema Legacy | Sistema de Eventos |
|---------|---------------|-------------------|
| **Historia** | Se pierde al actualizar | Se preserva siempre |
| **Extensibilidad** | Requiere migraciones | Solo nuevos event_types |
| **Auditoría** | Limitada o inexistente | Total y automática |
| **Consistencia** | Puede desincronizarse | Siempre consistente |
| **Debugging** | Difícil ("¿por qué este estado?") | Fácil (lee la secuencia) |
| **Escalabilidad** | Limitada por diseño | Preparada para millones |

## Conclusión

`energy_events` es el núcleo porque:

1. **Es inmutable**: La historia nunca se pierde
2. **Es extensible**: Nuevos conceptos sin cambios de esquema
3. **Es única**: Single source of truth
4. **Es auditable**: Trazabilidad total
5. **Es escalable**: Diseñada para crecer
6. **Es flexible**: Estado calculado, no almacenado

Esta arquitectura permite que AuriPortal evolucione infinitamente sin romper lo existente. Es la base sobre la que se construirá todo el sistema energético futuro.


















