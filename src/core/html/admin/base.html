<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="theme-color" content="#0f172a">
  <meta name="description" content="Panel de administración de AuriPortal">
  <title>{{TITLE}} - AuriPortal Admin</title>
  <link href="/css/tailwind.css" rel="stylesheet">
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #0f172a; /* slate-900 */
    }
    
    /* Scrollbar del sidebar - más ancho y visible */
    .sidebar-scroll {
      scrollbar-width: thin;
      scrollbar-color: #475569 #1e293b;
    }
    .sidebar-scroll::-webkit-scrollbar {
      width: 12px; /* Más ancho para mejor accesibilidad */
    }
    .sidebar-scroll::-webkit-scrollbar-track {
      background: #1e293b; /* slate-800 */
      border-left: 1px solid #334155; /* Separación visual */
    }
    .sidebar-scroll::-webkit-scrollbar-thumb {
      background: #475569; /* slate-600 */
      border-radius: 6px;
      border: 2px solid #1e293b; /* Espacio para evitar solapamiento */
    }
    .sidebar-scroll::-webkit-scrollbar-thumb:hover {
      background: #64748b; /* slate-500 */
    }
    .sidebar-scroll::-webkit-scrollbar-thumb:active {
      background: #94a3b8; /* slate-400 */
    }
    
    /* Active menu item */
    .menu-item-active {
      background-color: #4f46e5;
      color: white;
    }
    
    /* Custom scrollbar for main content */
    .content-scroll::-webkit-scrollbar {
      width: 8px;
    }
    .content-scroll::-webkit-scrollbar-track {
      background: #1e293b;
    }
    .content-scroll::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 4px;
    }
    .content-scroll::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }
    
    /* Sidebar collapse styles */
    .sidebar {
      transition: width 0.3s ease;
      position: relative;
      min-width: 4rem;
      max-width: 500px;
    }
    .sidebar.collapsed {
      width: 4rem !important;
    }
    .sidebar.collapsed .sidebar-resizer {
      display: none;
    }
    
    /* Sidebar resizer */
    .sidebar-resizer {
      position: absolute;
      right: -4px;
      top: 0;
      bottom: 0;
      width: 8px;
      cursor: col-resize;
      background-color: transparent;
      z-index: 10;
      user-select: none;
      transition: background-color 0.2s;
    }
    .sidebar-resizer:hover {
      background-color: rgba(79, 70, 229, 0.6);
      width: 8px;
    }
    .sidebar-resizer.resizing {
      background-color: rgba(79, 70, 229, 0.9);
      width: 8px;
    }
    
    @media (max-width: 768px) {
      .sidebar-resizer {
        display: none;
      }
    }
    .sidebar.collapsed .sidebar-content {
      display: none;
    }
    .sidebar.collapsed .sidebar-icon {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .sidebar.collapsed .sidebar-header {
      justify-content: center;
      padding: 1rem 0.5rem;
    }
    .sidebar-toggle {
      background: transparent;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      padding: 0.375rem;
      border-radius: 0.375rem;
      transition: all 0.2s;
      opacity: 0.6;
      font-size: 1rem;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 1.75rem;
      height: 1.75rem;
      flex-shrink: 0;
    }
    .sidebar-toggle:hover {
      opacity: 1;
      background: rgba(51, 65, 85, 0.4);
      color: #cbd5e1;
    }
    .sidebar.collapsed .sidebar-toggle {
      margin: 0 auto;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-icon {
      display: none;
    }
    
    /* Secciones colapsables del sidebar */
    .sidebar-section-header {
      user-select: none;
      transition: all 0.2s ease;
    }
    .sidebar-section-header:hover {
      background-color: rgba(51, 65, 85, 0.4);
    }
    .sidebar-section-header[aria-expanded="true"] .sidebar-section-toggle {
      transform: rotate(180deg);
    }
    .sidebar-section-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
      opacity: 0;
    }
    .sidebar-section-content.open {
      max-height: 2000px; /* Valor suficientemente alto */
      opacity: 1;
    }
    .sidebar-section-toggle {
      transition: transform 0.2s ease;
      font-size: 0.75rem;
    }
    
    /* Responsive para móvil */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        z-index: 50;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      .sidebar.mobile-open {
        transform: translateX(0);
      }
      
      .sidebar.collapsed {
        transform: translateX(-100%);
      }
      
      /* Overlay para móvil */
      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 40;
      }
      
      .sidebar-overlay.active {
        display: block;
      }
      
      /* Botón hamburguesa */
      .mobile-menu-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: #1e293b;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 60;
        touch-action: manipulation;
      }
      
      /* Ajustar contenido principal en móvil */
      .main-content-wrapper {
        margin-left: 0;
        width: 100%;
      }
      
      /* Header responsive */
      header {
        padding: 12px 16px !important;
      }
      
      header h2 {
        font-size: 1.1rem !important;
        margin-left: 50px;
      }
      
      /* Tabs responsive */
      .tabs-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }
      
      .tabs-container::-webkit-scrollbar {
        height: 4px;
      }
      
      /* Contenido responsive */
      main {
        padding: 12px !important;
      }
      
      /* Ajustar tamaños de texto en móvil */
      .sidebar-content {
        font-size: 0.875rem;
      }
      
      /* Botones más grandes para touch */
      nav a, nav button {
        min-height: 44px;
        padding: 12px 16px !important;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-menu-button {
        display: none;
      }
      
      .sidebar-overlay {
        display: none !important;
      }
    }
  </style>
</head>
<body class="bg-slate-900">
  <!-- Botón hamburguesa para móvil -->
  <button id="mobile-menu-button" class="mobile-menu-button" aria-label="Abrir menú">
    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
  </button>
  
  <!-- Overlay para móvil -->
  <div id="sidebar-overlay" class="sidebar-overlay"></div>
  
  <!-- Layout con Sidebar -->
  <div class="flex h-screen overflow-hidden">
    
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-slate-950 text-slate-200 flex flex-col border-r border-slate-800">
      <!-- Resizer handle -->
      <div id="sidebar-resizer" class="sidebar-resizer" title="Arrastra para redimensionar"></div>
      
      <!-- Logo/Header -->
      <div class="p-4 border-b border-slate-800 sidebar-header">
        <h1 class="text-xl font-bold text-white sidebar-content">✨ AuriPortal Admin</h1>
        <div class="sidebar-icon">✨</div>
        <button id="sidebar-toggle" class="sidebar-toggle" title="Colapsar/Expandir menú" aria-label="Colapsar menú">
          <span class="sidebar-content">◀</span>
          <span class="sidebar-icon">◀</span>
        </button>
      </div>
      
      <!-- Navigation Menu -->
      <nav id="sidebar-nav" class="flex-1 overflow-y-auto sidebar-scroll px-2 py-4">
        <div class="space-y-1 sidebar-content">
          
          <!-- SIDEBAR CANÓNICO: Generado por sidebar-registry.js -->
          <!-- LEGACY SIDEBAR REMOVED — DO NOT USE -->
          <!-- El sidebar se genera automáticamente desde generateSidebarHTML() -->
          {{SIDEBAR_MENU}}
          
        </div>
      </nav>
    </aside>
    
    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden bg-slate-900 main-content-wrapper">
      
      <!-- Top Bar -->
      <header class="bg-slate-800 shadow-lg border-b border-slate-700 px-6 py-4">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-semibold text-white">{{TITLE}}</h2>
          <div class="text-sm text-slate-400">
            <span id="currentTime"></span>
          </div>
        </div>
      </header>
      
      <!-- Content -->
      <main class="flex-1 overflow-y-auto bg-slate-900 content-scroll">
        <div class="p-6">
          {{CONTENT}}
        </div>
      </main>
      
    </div>
  </div>
  
  <script>
      // VALIDACIÓN ANTI-REGRESIÓN CLIENTE: Detectar sidebar incompleto
      document.addEventListener('DOMContentLoaded', function() {
        // Verificar que el sidebar tenga contenido válido
        // NOTA: sidebarNav ahora es manejado por sidebar-client.js
        // Este código legacy se mantiene solo para validación
        const sidebarScroll = document.getElementById('admin-sidebar-scroll');
        if (sidebarScroll) {
          const sidebarLinks = sidebarScroll.querySelectorAll('a');
          const sidebarText = sidebarScroll.textContent || '';
          
          // Detectar problemas comunes
          if (sidebarText.includes('{{SIDEBAR_MENU}}')) {
            console.error('[SIDEBAR_FIX] ❌ Placeholder {{SIDEBAR_MENU}} sin reemplazar detectado en cliente');
          } else if (sidebarLinks.length < 2) {
            console.warn('[SIDEBAR_FIX] ⚠️ Sidebar tiene menos de 2 items visibles', {
              linkCount: sidebarLinks.length,
              textPreview: sidebarText.substring(0, 200)
            });
          } else if (sidebarLinks.length === 1 && sidebarText.includes('Dashboard')) {
          console.warn('[SIDEBAR_FIX] ⚠️ Sidebar solo muestra Dashboard (posible error)', {
            linkCount: sidebarLinks.length
          });
        }
      }
      
      // NOTA: El resaltado de menú activo, scroll, toggle y resize ahora se manejan completamente
      // en sidebar-client.js. Este código legacy ha sido eliminado para evitar:
      // - Redeclaraciones de variables (sidebarNav)
      // - Conflictos de listeners
      // - Duplicación de lógica
      
      // Cargar favoritos
      loadFavoritos();
      
      // Actualizar reloj
      function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-ES', { 
          hour: '2-digit', 
          minute: '2-digit',
          second: '2-digit'
        });
        const dateString = now.toLocaleDateString('es-ES', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
          timeElement.textContent = dateString + ' - ' + timeString;
        }
      }
      
      updateTime();
      setInterval(updateTime, 1000);
    });
    
    // Cargar favoritos dinámicamente
    let loadFavoritosErrorCount = 0;
    async function loadFavoritos() {
      try {
        const response = await fetch('/admin/api/favoritos', {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        // Verificar status HTTP primero
        if (response.status === 502 || response.status === 503 || response.status === 504) {
          loadFavoritosErrorCount++;
          // No mostrar error repetitivo
          if (loadFavoritosErrorCount <= 1) {
            const container = document.getElementById('favoritos-container');
            if (container) {
              container.innerHTML = '<p class="px-3 py-2 text-xs text-slate-500">Configura tus favoritos en Configuración</p>';
            }
          }
          return;
        }
        
        // Leer el texto de la respuesta una sola vez
        const text = await response.text();
        
        // Verificar que la respuesta sea JSON antes de parsear
        const contentType = response.headers.get('content-type') || '';
        const isJsonContentType = contentType.includes('application/json');
        
        // Si es HTML (empieza con <!DOCTYPE, <html, o simplemente <), es un error
        const trimmedText = text.trim();
        if (trimmedText.startsWith('<!DOCTYPE') || trimmedText.startsWith('<html') || 
            (trimmedText.startsWith('<') && !trimmedText.startsWith('{'))) {
          loadFavoritosErrorCount++;
          // No mostrar error repetitivo
          if (loadFavoritosErrorCount <= 1) {
            const container = document.getElementById('favoritos-container');
            if (container) {
              container.innerHTML = '<p class="px-3 py-2 text-xs text-slate-500">Configura tus favoritos en Configuración</p>';
            }
          }
          return;
        }
        
        // Intentar parsear como JSON
        let favoritos;
        try {
          favoritos = JSON.parse(text);
        } catch (parseError) {
          // Si el error es porque el texto contiene HTML, no lanzar error
          if (parseError.message && parseError.message.includes('Unexpected token') && 
              (text.includes('<!DOCTYPE') || text.includes('<html') || text.trim().startsWith('<'))) {
            loadFavoritosErrorCount++;
            if (loadFavoritosErrorCount <= 1) {
              const container = document.getElementById('favoritos-container');
              if (container) {
                container.innerHTML = '<p class="px-3 py-2 text-xs text-slate-500">Configura tus favoritos en Configuración</p>';
              }
            }
            return;
          }
          
          // Si no se puede parsear y no es HTML, es un error
          if (!isJsonContentType) {
            loadFavoritosErrorCount++;
            if (loadFavoritosErrorCount <= 1) {
              const container = document.getElementById('favoritos-container');
              if (container) {
                container.innerHTML = '<p class="px-3 py-2 text-xs text-slate-500">Configura tus favoritos en Configuración</p>';
              }
            }
            return;
          }
          throw parseError;
        }
        
        // Si la respuesta no es OK pero tenemos JSON, verificar si hay error en el JSON
        if (!response.ok) {
          loadFavoritosErrorCount++;
          if (loadFavoritosErrorCount <= 1) {
            const container = document.getElementById('favoritos-container');
            if (container) {
              container.innerHTML = '<p class="px-3 py-2 text-xs text-slate-500">Configura tus favoritos en Configuración</p>';
            }
          }
          return;
        }
        
        // Si llegamos aquí, la carga fue exitosa
        loadFavoritosErrorCount = 0;
        
        const container = document.getElementById('favoritos-container');
        if (!container) return;
        
        if (favoritos.length === 0) {
          container.innerHTML = '<p class="px-3 py-2 text-xs text-slate-500">Configura tus favoritos en Configuración</p>';
          return;
        }
        
        container.innerHTML = favoritos.map(f => `
          <a href="${f.ruta}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-slate-800 transition-colors">
            <span class="mr-3 text-lg">${f.icono || '⭐'}</span>
            ${f.nombre}
          </a>
        `).join('');
        
        // Resaltar favorito activo si corresponde
        const currentPath = window.location.pathname;
        container.querySelectorAll('a').forEach(item => {
          if (item.getAttribute('href') === currentPath) {
            item.classList.add('menu-item-active');
          }
        });
      } catch (error) {
        loadFavoritosErrorCount++;
        // Solo mostrar error en consola si no es un error repetitivo
        if (loadFavoritosErrorCount <= 3) {
          console.error('Error cargando favoritos:', error);
        }
        const container = document.getElementById('favoritos-container');
        if (container && loadFavoritosErrorCount <= 1) {
          container.innerHTML = '<p class="px-3 py-2 text-xs text-slate-500">Configura tus favoritos en Configuración</p>';
        }
      }
    }
    
    // Manejo del menú móvil
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    
    function openMobileMenu() {
      sidebar?.classList.add('mobile-open');
      sidebarOverlay?.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeMobileMenu() {
      sidebar?.classList.remove('mobile-open');
      sidebarOverlay?.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    mobileMenuButton?.addEventListener('click', openMobileMenu);
    sidebarOverlay?.addEventListener('click', closeMobileMenu);
    
    // Cerrar menú al hacer click en un enlace (móvil)
    if (window.innerWidth <= 768) {
      document.querySelectorAll('aside nav a').forEach(link => {
        link.addEventListener('click', () => {
          setTimeout(closeMobileMenu, 100);
        });
      });
    }
    
    // Cerrar menú al redimensionar a desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        closeMobileMenu();
      }
    });
    
    
  </script>
  
  <style>
    .menu-dropdown button {
      cursor: pointer;
    }
    #listas-menu {
      max-height: 400px;
      overflow-y: auto;
    }
    #listas-arrow {
      transition: transform 0.2s ease;
    }
  </style>
  
  <!-- Error Handler - Debe cargarse ANTES de otros scripts para capturar errores de extensiones -->
  <script src="/js/error-handler.js">  </script>
  
  <!-- Sidebar Runtime State Management -->
  <script src="/js/admin/sidebar-client.js"></script>
</body>
</html>
