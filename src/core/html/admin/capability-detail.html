<!-- Vista detalle: Capability Detail -->
<!-- Breadcrumb -->
<nav class="mb-6">
    <a href="/admin/system/capabilities" class="text-indigo-400 hover:text-indigo-300">
      ← Volver a Capabilities
    </a>
  </nav>
  
  <!-- Loading state -->
  <div id="loading-state" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
    <p class="mt-4 text-slate-400">Cargando capability...</p>
  </div>
  
  <!-- Error state -->
  <div id="error-state" class="hidden text-center py-12">
    <p class="text-red-400 mb-4">Error al cargar capability</p>
    <button 
      onclick="loadCapability()" 
      class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
    >
      Reintentar
    </button>
  </div>
  
  <!-- Content -->
  <div id="content" class="hidden">
    <!-- Header -->
    <div class="bg-slate-800 rounded-lg p-6 mb-6">
      <div class="flex items-start justify-between mb-4">
        <div>
          <div class="flex items-center gap-3 mb-2">
            <h1 id="capability-id" class="text-3xl font-bold text-white"></h1>
            <span id="status-badge" class="px-3 py-1 text-sm rounded"></span>
          </div>
          <p id="capability-type" class="text-slate-400 text-sm uppercase tracking-wide"></p>
        </div>
      </div>
      <div id="capability-name" class="text-xl font-semibold text-slate-200 mb-4"></div>
      <p id="capability-description" class="text-slate-300 leading-relaxed"></p>
    </div>
    
    <!-- Contrato Técnico -->
    <div id="contract-section" class="bg-slate-800 rounded-lg p-6 mb-6 hidden">
      <h2 class="text-xl font-bold text-white mb-4">Contrato Técnico</h2>
      <div id="contract-content"></div>
    </div>
    
    <!-- Compatibilidades -->
    <div id="compatibilities-section" class="bg-slate-800 rounded-lg p-6 mb-6 hidden">
      <h2 class="text-xl font-bold text-white mb-4">Compatibilidades</h2>
      <div id="compatibilities-content"></div>
    </div>
    
    <!-- Información Adicional -->
    <div id="additional-section" class="bg-slate-800 rounded-lg p-6 mb-6 hidden">
      <h2 class="text-xl font-bold text-white mb-4">Información Adicional</h2>
      <div id="additional-content"></div>
    </div>
  </div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const pathParts = window.location.pathname.split('/');
  const type = pathParts[pathParts.length - 2];
  const id = pathParts[pathParts.length - 1];
  
  // Cargar capability al iniciar
  document.addEventListener('DOMContentLoaded', function() {
    loadCapability();
  });
  
  // Cargar capability desde API
  async function loadCapability() {
    const loadingEl = document.getElementById('loading-state');
    const errorEl = document.getElementById('error-state');
    const contentEl = document.getElementById('content');
    
    loadingEl.classList.remove('hidden');
    errorEl.classList.add('hidden');
    contentEl.classList.add('hidden');
    
    try {
      const response = await fetch('/admin/api/registry', {
        headers: {
          'X-Admin-Panel': 'true'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const registryData = await response.json();
      
      // Buscar capability
      let capability = null;
      let capabilityType = '';
      
      switch (type) {
        case 'screen-templates':
          capability = (registryData.screenTemplates || []).find(c => c.id === id);
          capabilityType = 'ScreenTemplate';
          break;
        case 'step-types':
          capability = (registryData.stepTypes || []).find(c => c.id === id);
          capabilityType = 'StepType';
          break;
        case 'conditions':
          capability = (registryData.conditions || []).find(c => c.id === id);
          capabilityType = 'Condition';
          break;
        case 'events':
          capability = (registryData.events || []).find(c => c.id === id);
          capabilityType = 'Event';
          break;
        case 'pde-resources':
          capability = (registryData.pdeResources || []).find(c => c.id === id);
          capabilityType = 'PDE Resource';
          break;
      }
      
      if (!capability) {
        throw new Error('Capability no encontrada');
      }
      
      loadingEl.classList.add('hidden');
      contentEl.classList.remove('hidden');
      
      renderCapability(capability, capabilityType, registryData);
      
    } catch (error) {
      console.error('Error cargando capability:', error);
      loadingEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
    }
  }
  
  // Renderizar capability
  function renderCapability(capability, capabilityType, registryData) {
    // Header
    document.getElementById('capability-id').textContent = capability.id || 'N/A';
    document.getElementById('capability-type').textContent = capabilityType;
    
    const status = (capability.feature_flag || 'on').toLowerCase();
    const statusBadge = document.getElementById('status-badge');
    if (status === 'on') {
      statusBadge.className = 'px-3 py-1 text-sm bg-green-900 text-green-200 rounded';
      statusBadge.textContent = 'ON';
    } else if (status === 'beta') {
      statusBadge.className = 'px-3 py-1 text-sm bg-yellow-900 text-yellow-200 rounded';
      statusBadge.textContent = 'BETA';
    } else {
      statusBadge.className = 'px-3 py-1 text-sm bg-red-900 text-red-200 rounded';
      statusBadge.textContent = 'OFF';
    }
    
    if (capability.name) {
      document.getElementById('capability-name').textContent = capability.name;
    } else {
      document.getElementById('capability-name').classList.add('hidden');
    }
    
    if (capability.description) {
      document.getElementById('capability-description').textContent = capability.description;
    } else {
      document.getElementById('capability-description').textContent = 'Sin descripción disponible.';
    }
    
    // Contrato Técnico
    renderContract(capability, capabilityType);
    
    // Compatibilidades
    renderCompatibilities(capability, capabilityType, registryData);
    
    // Información Adicional
    renderAdditional(capability);
  }
  
  // Renderizar contrato técnico
  function renderContract(capability, capabilityType) {
    const section = document.getElementById('contract-section');
    const content = document.getElementById('contract-content');
    let hasContent = false;
    let html = '';
    
    // Props schema (ScreenTemplates)
    if (capability.props_schema) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">Props Schema</h3>';
      html += '<pre class="bg-slate-900 p-4 rounded-lg overflow-x-auto text-sm text-slate-300">';
      html += escapeHtml(JSON.stringify(capability.props_schema, null, 2));
      html += '</pre>';
      html += '</div>';
    }
    
    // Params schema (Conditions)
    if (capability.params_schema) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">Params Schema</h3>';
      html += '<pre class="bg-slate-900 p-4 rounded-lg overflow-x-auto text-sm text-slate-300">';
      html += escapeHtml(JSON.stringify(capability.params_schema, null, 2));
      html += '</pre>';
      html += '</div>';
    }
    
    // Payload schema (Events)
    if (capability.payload_schema) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">Payload Schema</h3>';
      html += '<pre class="bg-slate-900 p-4 rounded-lg overflow-x-auto text-sm text-slate-300">';
      html += escapeHtml(JSON.stringify(capability.payload_schema, null, 2));
      html += '</pre>';
      html += '</div>';
    }
    
    // Ejemplo JSON (si existe)
    if (capability.example) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">Ejemplo</h3>';
      html += '<pre class="bg-slate-900 p-4 rounded-lg overflow-x-auto text-sm text-slate-300">';
      html += escapeHtml(JSON.stringify(capability.example, null, 2));
      html += '</pre>';
      html += '</div>';
    }
    
    if (hasContent) {
      content.innerHTML = html;
      section.classList.remove('hidden');
    } else {
      section.classList.add('hidden');
    }
  }
  
  // Renderizar compatibilidades
  function renderCompatibilities(capability, capabilityType, registryData) {
    const section = document.getElementById('compatibilities-section');
    const content = document.getElementById('compatibilities-content');
    let hasContent = false;
    let html = '';
    
    // StepTypes compatibles (ScreenTemplates)
    if (capability.compatible_step_types && Array.isArray(capability.compatible_step_types)) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">StepTypes Compatibles</h3>';
      html += '<div class="flex flex-wrap gap-2">';
      capability.compatible_step_types.forEach(stepTypeId => {
        html += `<span class="px-3 py-1 bg-indigo-900 text-indigo-200 rounded-lg text-sm">${escapeHtml(stepTypeId)}</span>`;
      });
      html += '</div>';
      html += '</div>';
    }
    
    // ScreenTemplates compatibles (StepTypes)
    if (capability.compatible_screen_templates && Array.isArray(capability.compatible_screen_templates)) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">ScreenTemplates Compatibles</h3>';
      html += '<div class="flex flex-wrap gap-2">';
      capability.compatible_screen_templates.forEach(templateId => {
        html += `<a href="/admin/system/capabilities/screen-templates/${escapeHtml(templateId)}" class="px-3 py-1 bg-indigo-900 text-indigo-200 rounded-lg text-sm hover:bg-indigo-800 transition-colors">${escapeHtml(templateId)}</a>`;
      });
      html += '</div>';
      html += '</div>';
    }
    
    // Contexto de evaluación (Conditions)
    if (capability.evaluation_context) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">Contexto de Evaluación</h3>';
      html += `<p class="text-slate-300">${escapeHtml(capability.evaluation_context)}</p>`;
      html += '</div>';
    }
    
    // Tipos de recurso PDE compatibles
    if (capability.compatible_resource_types && Array.isArray(capability.compatible_resource_types)) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">Tipos de Recurso PDE Compatibles</h3>';
      html += '<div class="flex flex-wrap gap-2">';
      capability.compatible_resource_types.forEach(resourceType => {
        html += `<span class="px-3 py-1 bg-purple-900 text-purple-200 rounded-lg text-sm">${escapeHtml(resourceType)}</span>`;
      });
      html += '</div>';
      html += '</div>';
    }
    
    if (hasContent) {
      content.innerHTML = html;
      section.classList.remove('hidden');
    } else {
      section.classList.add('hidden');
    }
  }
  
  // Renderizar información adicional
  function renderAdditional(capability) {
    const section = document.getElementById('additional-section');
    const content = document.getElementById('additional-content');
    let hasContent = false;
    let html = '';
    
    // Feature flag
    if (capability.feature_flag) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">Feature Flag</h3>';
      html += `<p class="text-slate-300">${escapeHtml(capability.feature_flag)}</p>`;
      html += '</div>';
    }
    
    // Version
    if (capability.version) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">Versión</h3>';
      html += `<p class="text-slate-300">${escapeHtml(capability.version)}</p>`;
      html += '</div>';
    }
    
    // Notas
    if (capability.notes) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">Notas</h3>';
      html += `<p class="text-slate-300 whitespace-pre-wrap">${escapeHtml(capability.notes)}</p>`;
      html += '</div>';
    }
    
    // Advertencias
    if (capability.warnings && Array.isArray(capability.warnings) && capability.warnings.length > 0) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-yellow-400 mb-2">⚠️ Advertencias</h3>';
      html += '<ul class="list-disc list-inside text-slate-300 space-y-1">';
      capability.warnings.forEach(warning => {
        html += `<li>${escapeHtml(warning)}</li>`;
      });
      html += '</ul>';
      html += '</div>';
    }
    
    // Políticas (Events)
    if (capability.policies && Array.isArray(capability.policies) && capability.policies.length > 0) {
      hasContent = true;
      html += '<div class="mb-4">';
      html += '<h3 class="text-lg font-semibold text-white mb-2">Políticas</h3>';
      html += '<ul class="list-disc list-inside text-slate-300 space-y-1">';
      capability.policies.forEach(policy => {
        html += `<li>${escapeHtml(policy)}</li>`;
      });
      html += '</ul>';
      html += '</div>';
    }
    
    if (hasContent) {
      content.innerHTML = html;
      section.classList.remove('hidden');
    } else {
      section.classList.add('hidden');
    }
  }
  
  // Escapar HTML
  function escapeHtml(text) {
    if (typeof text !== 'string') {
      text = String(text);
    }
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>

