<div class="p-6">
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-white mb-2">üß† Dise√±ador de Motores</h1>
        <p class="text-slate-400">{{SUBTITLE}}</p>
        <p class="text-slate-500 text-sm mt-1">Define la estructura reutilizable que generar√° este motor.</p>
      </div>
      <div>
        <a href="/admin/motors" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white font-medium rounded-lg transition-colors">
          ‚Üê Volver al Listado
        </a>
      </div>
    </div>
  </div>

  <div id="save-status" class="mb-4 hidden"></div>

  <!-- Tabs Navigation -->
  <div class="bg-slate-800 rounded-t-lg border-b border-slate-700">
    <div class="flex gap-2 px-4">
      <button onclick="openTab('tab-identidad')" id="tab-btn-identidad" class="tab-button bg-indigo-600 text-white px-4 py-2 rounded-t-lg hover:bg-indigo-700 transition-colors">
        1. Identidad
      </button>
      <button onclick="openTab('tab-inputs')" id="tab-btn-inputs" class="tab-button bg-slate-700 text-slate-300 px-4 py-2 rounded-t-lg hover:bg-slate-600 transition-colors">
        2. Inputs
      </button>
      <button onclick="openTab('tab-rules')" id="tab-btn-rules" class="tab-button bg-slate-700 text-slate-300 px-4 py-2 rounded-t-lg hover:bg-slate-600 transition-colors">
        3. Reglas
      </button>
      <button onclick="openTab('tab-outputs')" id="tab-btn-outputs" class="tab-button bg-slate-700 text-slate-300 px-4 py-2 rounded-t-lg hover:bg-slate-600 transition-colors">
        4. Output Estructural
      </button>
    </div>
  </div>

  <!-- Tab Content Container -->
  <div class="bg-slate-800 rounded-b-lg p-6">
    
    <!-- Tab 1: Identidad -->
    <div id="tab-identidad" class="tab-content">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Motor Key (can√≥nico, √∫nico)</label>
          <input type="text" id="motor_key" value="{{MOTOR_KEY}}" {{MOTOR_KEY_READONLY}} class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="motor_preparacion_practica">
          <p class="mt-1 text-xs text-slate-500">Clave √∫nica e inmutable. Solo se puede cambiar al crear.</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Nombre</label>
          <input type="text" id="name" value="{{NAME}}" class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Motor de Preparaci√≥n para la Pr√°ctica">
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Descripci√≥n</label>
          <textarea id="description" rows="3" class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Descripci√≥n del motor...">{{DESCRIPTION}}</textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Categor√≠a</label>
          <input type="text" id="category" value="{{CATEGORY}}" class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="preparacion">
        </div>

        <div class="flex items-center gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Versi√≥n</label>
            <input type="number" id="version" value="{{VERSION}}" readonly class="w-24 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Estado</label>
            <select id="status" class="px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="draft" {{STATUS === 'draft' ? 'selected' : ''}}>Borrador</option>
              <option value="published" {{STATUS === 'published' ? 'selected' : ''}}>Publicado</option>
              <option value="archived" {{STATUS === 'archived' ? 'selected' : ''}}>Archivado</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab 2: Inputs -->
    <div id="tab-inputs" class="tab-content hidden">
      <div class="space-y-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white">Inputs del Motor</h3>
          <button onclick="agregarInput()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded transition-colors">
            ‚ûï Agregar Input
          </button>
        </div>
        <div id="input-errors-container" class="hidden"></div>
        <div id="inputs-container" class="space-y-3">
          <!-- Los inputs se cargar√°n din√°micamente -->
        </div>
      </div>
    </div>

    <!-- Tab 3: Reglas -->
    <div id="tab-rules" class="tab-content hidden">
      <div class="space-y-4">
        <div class="mb-4">
          <h3 class="text-lg font-semibold text-white mb-2">Reglas Internas del Motor</h3>
          <p class="text-sm text-slate-400">Define la l√≥gica declarativa que procesa los inputs y genera la estructura.</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">JSON de Reglas</label>
          <textarea id="rules-json" rows="15" class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white font-mono text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder='{"description": "Reglas internas del motor", "logic": {}}'></textarea>
          <p class="mt-1 text-xs text-slate-500">Solo l√≥gica declarativa. No UI, no temas.</p>
        </div>
      </div>
    </div>

    <!-- Tab 4: Output Estructural -->
    <div id="tab-outputs" class="tab-content hidden">
      <div class="space-y-4">
        <div class="mb-4">
          <h3 class="text-lg font-semibold text-white mb-2">Output Estructural AXE</h3>
          <p class="text-sm text-slate-400">Define qu√© estructura AXE genera este motor (steps, edges, captures).</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Steps</label>
            <textarea id="outputs-steps" rows="10" class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white font-mono text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder='[]'></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Edges</label>
            <textarea id="outputs-edges" rows="10" class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white font-mono text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder='[]'></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Captures</label>
            <textarea id="outputs-captures" rows="10" class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white font-mono text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder='[]'></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="mt-6 pt-6 border-t border-slate-700 flex gap-4">
      <button onclick="guardarMotor()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors">
        üíæ Guardar Motor
      </button>
      <button onclick="validarMotor()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
        ‚úì Validar
      </button>
    </div>
  </div>
</div>

<script>
const motorId = '{{MOTOR_ID}}';
const isReadonly = {{IS_READONLY}} === true;
let currentDefinition = null;

// Inicializar definici√≥n desde el template
try {
  currentDefinition = JSON.parse(`{{DEFINITION}}`.replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>'));
} catch (e) {
  currentDefinition = { inputs: [], rules: {}, outputs: { steps: [], edges: [], captures: [] } };
}

// Inicializar primera pesta√±a
openTab('tab-identidad');

// Cargar cat√°logos disponibles para selects
let catalogsAvailable = [];
async function cargarCatalogos() {
  // #region agent log
  fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:165',message:'cargarCatalogos: inicio',data:{timestamp:Date.now()},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
  // #endregion
  try {
    const response = await fetch('/admin/pde/catalog-registry?format=json&usable_for_motors=true');
    const data = await response.json();
    // #region agent log
    fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:169',message:'cargarCatalogos: respuesta recibida',data:{success:data.success,catalogsCount:data.catalogs?.length || 0},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
    // #endregion
    if (data.success) {
      catalogsAvailable = data.catalogs || [];
      // #region agent log
      fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:171',message:'cargarCatalogos: cat√°logos asignados',data:{catalogsAvailableCount:catalogsAvailable.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
      // #endregion
    }
  } catch (error) {
    // #region agent log
    fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:173',message:'cargarCatalogos: error',data:{error:error.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
    // #endregion
    console.error('Error cargando cat√°logos:', error);
  }
}
cargarCatalogos();

  // Cargar inputs en la pesta√±a 2
cargarInputs();

// Actualizar estado del bot√≥n Guardar peri√≥dicamente
setInterval(actualizarEstadoBotonGuardar, 1000);

// Cargar reglas en la pesta√±a 3
if (currentDefinition.rules) {
  document.getElementById('rules-json').value = JSON.stringify(currentDefinition.rules, null, 2);
}

// Cargar outputs en la pesta√±a 4
if (currentDefinition.outputs) {
  document.getElementById('outputs-steps').value = JSON.stringify(currentDefinition.outputs.steps || [], null, 2);
  document.getElementById('outputs-edges').value = JSON.stringify(currentDefinition.outputs.edges || [], null, 2);
  document.getElementById('outputs-captures').value = JSON.stringify(currentDefinition.outputs.captures || [], null, 2);
}

function openTab(tabId) {
  // Ocultar todos los tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.add('hidden');
  });
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('bg-indigo-600', 'text-white');
    btn.classList.add('bg-slate-700', 'text-slate-300');
  });

  // Mostrar el tab seleccionado
  document.getElementById(tabId).classList.remove('hidden');
  const btnId = 'tab-btn-' + tabId.replace('tab-', '');
  const btn = document.getElementById(btnId);
  if (btn) {
    btn.classList.remove('bg-slate-700', 'text-slate-300');
    btn.classList.add('bg-indigo-600', 'text-white');
  }
}

function cargarInputs() {
  // #region agent log
  fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:213',message:'cargarInputs: inicio',data:{inputsCount:currentDefinition.inputs?.length || 0},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
  // #endregion
  const container = document.getElementById('inputs-container');
  container.innerHTML = '';

  if (!currentDefinition.inputs || currentDefinition.inputs.length === 0) {
    container.innerHTML = '<p class="text-slate-400 text-sm">No hay inputs definidos. Agrega uno para comenzar.</p>';
    // #region agent log
    fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:218',message:'cargarInputs: sin inputs',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
    // #endregion
    return;
  }

  currentDefinition.inputs.forEach((input, index) => {
    // #region agent log
    fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:240',message:'cargarInputs: renderizando input',data:{index,inputType:input.type,inputKey:input.key},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
    // #endregion
    const inputHtml = `
      <div class="bg-slate-900 p-4 rounded-lg border border-slate-700">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-3">
          <div>
            <label class="block text-xs text-slate-400 mb-1">Key <span class="text-red-400">*</span></label>
            <input type="text" data-input-index="${index}" data-field="key" value="${input.key || ''}" class="w-full px-3 py-2 bg-slate-800 border ${!input.key || input.key.trim() === '' ? 'border-red-500' : 'border-slate-600'} rounded text-white text-sm key-input" placeholder="cleaning_type">
            <div class="key-error text-xs text-red-400 mt-1 hidden">La key es obligatoria y debe ser v√°lida (a-z, 0-9, _)</div>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Tipo</label>
            <select data-input-index="${index}" data-field="type" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white text-sm">
              <option value="enum" ${input.type === 'enum' ? 'selected' : ''}>enum</option>
              <option value="select" ${input.type === 'select' ? 'selected' : ''}>select (cat√°logo)</option>
              <option value="pde_catalog" ${input.type === 'pde_catalog' ? 'selected' : ''}>üß© Cat√°logo PDE</option>
              <option value="number" ${input.type === 'number' ? 'selected' : ''}>number</option>
              <option value="string" ${input.type === 'string' ? 'selected' : ''}>string</option>
              <option value="boolean" ${input.type === 'boolean' ? 'selected' : ''}>boolean</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Requerido</label>
            <input type="checkbox" data-input-index="${index}" data-field="required" ${input.required ? 'checked' : ''} class="w-5 h-5">
          </div>
          <div>
            <button onclick="eliminarInput(${index})" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-colors">Eliminar</button>
          </div>
        </div>
        ${input.type === 'enum' ? `
          <div>
            <label class="block text-xs text-slate-400 mb-1">Opciones (separadas por comas)</label>
            <input type="text" data-input-index="${index}" data-field="options" value="${(input.options || []).join(', ')}" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white text-sm" placeholder="rapida, basica, profunda">
          </div>
        ` : ''}
        ${input.type === 'select' ? `
          <div class="space-y-2">
            <div>
              <label class="block text-xs text-slate-400 mb-1">Fuente del Cat√°logo</label>
              <select data-input-index="${index}" data-field="options_source_catalog" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white text-sm">
                <option value="">-- Seleccionar cat√°logo --</option>
                ${catalogsAvailable.map(cat => {
                  // Verificar si este cat√°logo est√° seleccionado
                  const selected = input._selected_catalog_key === cat.catalog_key ||
                                   (input.options_source?.catalog_key === cat.catalog_key) ||
                                   (input.options_source?.source === 'pde_catalog_registry' && !input._selected_catalog_key && input.key === cat.catalog_key);
                  return `<option value="${cat.catalog_key}" ${selected ? 'selected' : ''}>${cat.label} (${cat.catalog_key})</option>`;
                }).join('')}
              </select>
            </div>
            <div class="text-xs text-slate-500">
              El cat√°logo seleccionado se usar√° para generar las opciones del dropdown din√°micamente.
            </div>
          </div>
        ` : ''}
        ${input.type === 'pde_catalog' ? `
          <div class="space-y-2 mt-2">
            <div>
              <label class="block text-xs text-slate-400 mb-1">Cat√°logo PDE</label>
              <select data-input-index="${index}" data-field="catalog_key" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white text-sm">
                <option value="">-- Seleccionar cat√°logo --</option>
                ${catalogsAvailable.map(cat => {
                  const selected = input.catalog_key === cat.catalog_key;
                  return `<option value="${cat.catalog_key}" ${selected ? 'selected' : ''}>${cat.label} (${cat.catalog_key})</option>`;
                }).join('')}
              </select>
            </div>
            ${input.capabilities ? `
              <div class="mt-3 p-3 bg-slate-800 rounded-lg border border-slate-700">
                <label class="block text-xs text-slate-400 mb-2 font-medium">Capacidades del Cat√°logo (read-only)</label>
                <div class="flex flex-wrap gap-2">
                  ${input.capabilities.supports_level ? '<span class="px-2 py-1 bg-blue-600 text-white text-xs rounded font-medium">Nivel</span>' : ''}
                  ${input.capabilities.supports_priority ? '<span class="px-2 py-1 bg-purple-600 text-white text-xs rounded font-medium">Prioridad</span>' : ''}
                  ${input.capabilities.supports_obligatory ? '<span class="px-2 py-1 bg-orange-600 text-white text-xs rounded font-medium">Obligatorio</span>' : ''}
                  ${input.capabilities.supports_duration ? '<span class="px-2 py-1 bg-cyan-600 text-white text-xs rounded font-medium">Duraci√≥n</span>' : ''}
                  ${!input.capabilities.supports_level && !input.capabilities.supports_priority && !input.capabilities.supports_obligatory && !input.capabilities.supports_duration ? '<span class="text-slate-500 text-xs italic">Sin capacidades especiales</span>' : ''}
                </div>
              </div>
            ` : ''}
          </div>
        ` : ''}
      </div>
    `;
    container.innerHTML += inputHtml;
    // #region agent log
    fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:324',message:'cargarInputs: HTML agregado al container',data:{index,htmlLength:inputHtml.length,hasPdeCatalogInHtml:inputHtml.includes('pde_catalog')},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
    // #endregion
  });

  // Agregar event listeners
  container.querySelectorAll('input, select').forEach(el => {
    el.addEventListener('change', actualizarInput);
  });
  
  // Agregar validaci√≥n en tiempo real para campos key
  container.querySelectorAll('[data-field="key"]').forEach(el => {
    el.addEventListener('input', validarKeyInput);
    el.addEventListener('blur', validarKeyInput);
  });
  
  // #region agent log
  // Verificar que los selectores se renderizaron correctamente
  setTimeout(() => {
    const allSelects = container.querySelectorAll('[data-field="type"]');
    fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:334',message:'cargarInputs: verificando selectores',data:{selectsCount:allSelects.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    allSelects.forEach((select, idx) => {
      const options = Array.from(select.options).map(opt => ({value: opt.value, text: opt.text}));
      const hasPdeCatalog = options.some(opt => opt.value === 'pde_catalog');
      fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:338',message:'cargarInputs: selector verificado',data:{index:idx,optionsCount:options.length,options,hasPdeCatalog,selectHTML:select.outerHTML.substring(0,300)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    });
  }, 100);
  // #endregion
  
  // Cargar cat√°logos en los selects si el tipo cambi√≥
  container.querySelectorAll('[data-field="type"]').forEach(select => {
    select.addEventListener('change', function() {
      const index = parseInt(this.dataset.inputIndex);
      if (this.value === 'select' || this.value === 'pde_catalog') {
        // Recargar para mostrar el selector de cat√°logos
        cargarInputs();
      }
    });
  });
  
  // Manejar selecci√≥n de cat√°logo para pde_catalog
  container.querySelectorAll('[data-field="catalog_key"]').forEach(select => {
    select.addEventListener('change', async function() {
      const index = parseInt(this.dataset.inputIndex);
      const catalogKey = this.value;
      
      // Validar √≠ndice y existencia del input
      if (!currentDefinition || !currentDefinition.inputs || !Array.isArray(currentDefinition.inputs)) {
        console.error('cargarInputs: currentDefinition.inputs no est√° inicializado');
        return;
      }
      
      if (isNaN(index) || index < 0 || index >= currentDefinition.inputs.length) {
        console.error('cargarInputs: √≠ndice inv√°lido', { index, length: currentDefinition.inputs.length });
        return;
      }
      
      const input = currentDefinition.inputs[index];
      
      if (catalogKey && input && input.type === 'pde_catalog') {
        // Cargar informaci√≥n del cat√°logo para autocompletar capabilities
        try {
          const response = await fetch(`/admin/pde/catalog-registry?format=json&usable_for_motors=true`);
          const data = await response.json();
          if (data.success) {
            const catalog = data.catalogs.find(cat => cat.catalog_key === catalogKey);
            if (catalog) {
              // Autocompletar capabilities
              input.catalog_key = catalogKey;
              input.capabilities = {
                supports_level: catalog.supports_level || false,
                supports_priority: catalog.supports_priority || false,
                supports_obligatory: catalog.supports_obligatory || false,
                supports_duration: catalog.supports_duration || false
              };
              // Recargar para mostrar las capabilities
              cargarInputs();
            }
          }
        } catch (error) {
          console.error('Error al cargar cat√°logo:', error);
        }
      } else if (!catalogKey && input && input.type === 'pde_catalog') {
        // Limpiar si se deselecciona
        delete input.catalog_key;
        delete input.capabilities;
        cargarInputs();
      }
    });
  });
  
  // Cargar cat√°logos en los dropdowns existentes
  container.querySelectorAll('[data-field="options_source_catalog"]').forEach(select => {
    const index = parseInt(select.dataset.inputIndex);
    
    // Validar √≠ndice y existencia del input
    if (!currentDefinition || !currentDefinition.inputs || !Array.isArray(currentDefinition.inputs)) {
      return;
    }
    
    if (isNaN(index) || index < 0 || index >= currentDefinition.inputs.length) {
      return;
    }
    
    const input = currentDefinition.inputs[index];
    if (input && input.options_source && input.options_source.source === 'pde_catalog_registry') {
      // Ya est√° seleccionado, mantenerlo
      const catalogKey = input.options_source.value_field === 'catalog_key' ? 
        (input.options_source.filter?.catalog_key || input.options_source.filter?.usable_for_motors === true ? '' : '') : '';
      // El selected ya est√° manejado en el template
    }
  });
}

function agregarInput() {
  // #region agent log
  fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:373',message:'agregarInput: inicio',data:{inputsBefore:currentDefinition.inputs?.length || 0},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
  // #endregion
  if (!currentDefinition.inputs) {
    currentDefinition.inputs = [];
  }
  currentDefinition.inputs.push({
    key: '',
    type: 'string',
    required: false
  });
  // #region agent log
  fetch('http://localhost:7242/ingest/a630ca16-542f-4dbf-9bac-2114a2a30cf8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'motors-editar.html:381',message:'agregarInput: input agregado',data:{inputsAfter:currentDefinition.inputs.length,newInputType:currentDefinition.inputs[currentDefinition.inputs.length-1].type},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
  // #endregion
  cargarInputs();
}

function eliminarInput(index) {
  if (confirm('¬øEliminar este input?')) {
    currentDefinition.inputs.splice(index, 1);
    cargarInputs();
  }
}

function actualizarInput(e) {
  const index = parseInt(e.target.dataset.inputIndex);
  const field = e.target.dataset.field;
  const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;

  // Validar que currentDefinition.inputs existe y el √≠ndice es v√°lido
  if (!currentDefinition || !currentDefinition.inputs || !Array.isArray(currentDefinition.inputs)) {
    console.error('actualizarInput: currentDefinition.inputs no est√° inicializado');
    return;
  }

  if (isNaN(index) || index < 0 || index >= currentDefinition.inputs.length) {
    console.error('actualizarInput: √≠ndice inv√°lido', { index, length: currentDefinition.inputs.length });
    return;
  }

  const input = currentDefinition.inputs[index];
  if (!input) {
    console.error('actualizarInput: input no existe en el √≠ndice', index);
    return;
  }

  if (field === 'options') {
    input.options = value.split(',').map(s => s.trim()).filter(s => s);
  } else if (field === 'options_source_catalog') {
    // Actualizar options_source cuando se selecciona un cat√°logo
    if (value) {
      // Almacenar el catalog_key seleccionado
      input._selected_catalog_key = value;
      // Actualizar options_source con el cat√°logo seleccionado
      // El sistema en runtime usar√° este catalog_key para obtener las opciones del cat√°logo
      input.options_source = {
        source: 'pde_catalog_registry',
        value_field: 'catalog_key',
        label_field: 'label',
        filter: { usable_for_motors: true },
        catalog_key: value  // Cat√°logo espec√≠fico seleccionado
      };
      
      // AUTOGENERAR KEY si est√° vac√≠a
      if (!input.key || input.key.trim() === '') {
        input.key = 'catalogo_' + value;
        // Actualizar el campo visual
        const keyInput = document.querySelector(`[data-input-index="${index}"][data-field="key"]`);
        if (keyInput) {
          keyInput.value = input.key;
          validarKeyInput({ target: keyInput });
        }
      }
    } else {
      delete input.options_source;
      delete input._selected_catalog_key;
    }
  } else if (field === 'catalog_key') {
    // Para pde_catalog, el catalog_key se maneja en el event listener del select
    // Solo actualizar aqu√≠ si es necesario
    if (value) {
      input.catalog_key = value;
    } else {
      delete input.catalog_key;
      delete input.capabilities;
    }
  } else if (field === 'type') {
    input.type = value;
    // Si cambia el tipo, limpiar campos espec√≠ficos
    if (value !== 'pde_catalog') {
      delete input.catalog_key;
      delete input.capabilities;
    }
    if (value !== 'select') {
      delete input.options_source;
      delete input._selected_catalog_key;
    }
    if (value === 'select' || value === 'pde_catalog') {
      // Recargar para mostrar el selector de cat√°logos
      cargarInputs();
    }
  } else {
    input[field] = value;
  }
}

async function guardarMotor() {
  if (isReadonly) {
    alert('No se puede editar un motor publicado. Usa "Duplicar" para crear una nueva versi√≥n.');
    return;
  }

  // Validar inputs antes de guardar
  const validacion = validarTodosLosInputs();
  if (!validacion.valid) {
    mostrarEstado('Error: ' + validacion.errors.join('; '), 'error');
    // Cambiar a la pesta√±a de inputs para mostrar errores
    openTab('tab-inputs');
    return;
  }

  // Recopilar datos de todas las pesta√±as
  const motorData = {
    motor_key: document.getElementById('motor_key').value,
    name: document.getElementById('name').value,
    description: document.getElementById('description').value,
    category: document.getElementById('category').value,
    status: document.getElementById('status').value
  };

  // Recopilar inputs (usar currentDefinition.inputs que ya tiene options_source actualizado)
  const inputs = [];
  
  // Validar que currentDefinition.inputs existe
  if (!currentDefinition || !currentDefinition.inputs || !Array.isArray(currentDefinition.inputs)) {
    alert('Error: La definici√≥n de inputs no est√° inicializada correctamente');
    return;
  }
  
  document.querySelectorAll('[data-input-index]').forEach(el => {
    const index = parseInt(el.dataset.inputIndex);
    if (isNaN(index) || index < 0) {
      console.warn('guardarMotor: √≠ndice inv√°lido', index);
      return;
    }
    
    if (!inputs[index]) {
      // Copiar el input actual para mantener options_source, catalog_key, capabilities y otros campos
      inputs[index] = (currentDefinition.inputs[index] && index < currentDefinition.inputs.length) 
        ? { ...currentDefinition.inputs[index] } 
        : {};
    }
    const field = el.dataset.field;
    if (field === 'options') {
      inputs[index].options = el.value.split(',').map(s => s.trim()).filter(s => s);
    } else if (field === 'required') {
      inputs[index].required = el.checked;
    } else if (field === 'options_source_catalog') {
      // Ya est√° actualizado en currentDefinition.inputs por actualizarInput()
      // No hacer nada aqu√≠
    } else if (field === 'catalog_key') {
      // Para pde_catalog, el catalog_key ya est√° en currentDefinition.inputs
      // Solo asegurar que se mantiene
      if (el.value) {
        inputs[index].catalog_key = el.value;
      }
    } else {
      inputs[index][field] = el.value;
    }
  });
  
  // Limpiar campos internos antes de guardar (pero mantener catalog_key y capabilities)
  inputs.forEach(input => {
    if (input._selected_catalog_key) {
      delete input._selected_catalog_key;
    }
  });
  
  // Filtrar inputs sin key (no deber√≠a pasar si la validaci√≥n funciona)
  currentDefinition.inputs = inputs.filter(i => i.key && i.key.trim() !== '');

  // Recopilar rules
  try {
    currentDefinition.rules = JSON.parse(document.getElementById('rules-json').value);
  } catch (e) {
    alert('Error en el JSON de reglas: ' + e.message);
    return;
  }

  // Recopilar outputs
  try {
    currentDefinition.outputs = {
      steps: JSON.parse(document.getElementById('outputs-steps').value || '[]'),
      edges: JSON.parse(document.getElementById('outputs-edges').value || '[]'),
      captures: JSON.parse(document.getElementById('outputs-captures').value || '[]')
    };
  } catch (e) {
    alert('Error en el JSON de outputs: ' + e.message);
    return;
  }

  motorData.definition = currentDefinition;

  try {
    const url = motorId === 'nuevo' ? '/admin/pde/motors' : `/admin/pde/motors/${motorId}`;
    const method = motorId === 'nuevo' ? 'POST' : 'PUT';

    const response = await fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(motorData)
    });

    const data = await response.json();
    if (data.success) {
      mostrarEstado('Motor guardado correctamente', 'success');
      if (motorId === 'nuevo') {
        setTimeout(() => {
          window.location.href = `/admin/motors/editar/${data.motor.id}`;
        }, 1000);
      }
    } else {
      mostrarEstado('Error: ' + (data.error || 'Error desconocido'), 'error');
    }
  } catch (error) {
    console.error('Error al guardar motor:', error);
    mostrarEstado('Error al guardar motor: ' + error.message, 'error');
  }
}

function validarMotor() {
  // Validar definici√≥n
  const validation = {
    valid: true,
    errors: []
  };

  if (!currentDefinition.inputs || currentDefinition.inputs.length === 0) {
    validation.errors.push('Debe haber al menos un input');
    validation.valid = false;
  }

  currentDefinition.inputs.forEach((input, index) => {
    if (!input.key) {
      validation.errors.push(`Input ${index + 1}: falta "key"`);
      validation.valid = false;
    }
    if (!input.type) {
      validation.errors.push(`Input ${index + 1}: falta "type"`);
      validation.valid = false;
    }
    if (input.type === 'enum' && (!input.options || input.options.length === 0)) {
      validation.errors.push(`Input ${index + 1}: los enum deben tener opciones`);
      validation.valid = false;
    }
    if (input.type === 'pde_catalog') {
      if (!input.catalog_key) {
        validation.errors.push(`Input ${index + 1}: los pde_catalog deben tener un "catalog_key"`);
        validation.valid = false;
      }
    }
  });

  if (!currentDefinition.outputs) {
    validation.errors.push('Faltan outputs');
    validation.valid = false;
  } else {
    if (!Array.isArray(currentDefinition.outputs.steps)) {
      validation.errors.push('outputs.steps debe ser un array');
      validation.valid = false;
    }
    if (!Array.isArray(currentDefinition.outputs.edges)) {
      validation.errors.push('outputs.edges debe ser un array');
      validation.valid = false;
    }
    if (!Array.isArray(currentDefinition.outputs.captures)) {
      validation.errors.push('outputs.captures debe ser un array');
      validation.valid = false;
    }
  }

  if (validation.valid) {
    alert('‚úì Motor v√°lido');
  } else {
    alert('‚úó Errores de validaci√≥n:\n' + validation.errors.join('\n'));
  }
}

function mostrarEstado(mensaje, tipo) {
  const statusEl = document.getElementById('save-status');
  statusEl.textContent = mensaje;
  statusEl.className = `mb-4 p-3 rounded ${tipo === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`;
  statusEl.classList.remove('hidden');
  setTimeout(() => {
    statusEl.classList.add('hidden');
  }, 3000);
}

// Validar formato de key: ^[a-z][a-z0-9_]*$
function validarFormatoKey(key) {
  if (!key || typeof key !== 'string') return false;
  const trimmed = key.trim();
  if (trimmed === '') return false;
  const regex = /^[a-z][a-z0-9_]*$/;
  return regex.test(trimmed);
}

// Validar key en tiempo real
function validarKeyInput(e) {
  const input = e.target;
  const index = parseInt(input.dataset.inputIndex);
  const key = input.value.trim();
  const errorDiv = input.parentElement.querySelector('.key-error');
  const isValid = validarFormatoKey(key);
  
  // Actualizar estado visual
  if (isValid || key === '') {
    input.classList.remove('border-red-500');
    input.classList.add('border-slate-600');
    if (errorDiv) errorDiv.classList.add('hidden');
  } else {
    input.classList.remove('border-slate-600');
    input.classList.add('border-red-500');
    if (errorDiv) errorDiv.classList.remove('hidden');
  }
  
  // Actualizar en currentDefinition
  if (currentDefinition && currentDefinition.inputs && currentDefinition.inputs[index]) {
    currentDefinition.inputs[index].key = key;
  }
  
  // Actualizar estado del bot√≥n Guardar
  actualizarEstadoBotonGuardar();
}

// Validar todos los inputs y retornar errores
function validarTodosLosInputs() {
  const errores = [];
  
  if (!currentDefinition || !currentDefinition.inputs || !Array.isArray(currentDefinition.inputs)) {
    return { valid: false, errors: ['La definici√≥n de inputs no est√° inicializada'] };
  }
  
  currentDefinition.inputs.forEach((input, index) => {
    if (!input.key || input.key.trim() === '') {
      errores.push(`Input ${index + 1}: La key es obligatoria`);
    } else if (!validarFormatoKey(input.key)) {
      errores.push(`Input ${index + 1}: La key "${input.key}" no es v√°lida. Debe empezar con letra min√∫scula y contener solo letras min√∫sculas, n√∫meros y guiones bajos`);
    }
    
    if (!input.type) {
      errores.push(`Input ${index + 1}: El tipo es obligatorio`);
    }
    
    if (input.type === 'enum' && (!input.options || input.options.length === 0)) {
      errores.push(`Input ${index + 1}: Los enum deben tener opciones`);
    }
    
    if (input.type === 'pde_catalog' && (!input.catalog_key || input.catalog_key.trim() === '')) {
      errores.push(`Input ${index + 1}: Los pde_catalog deben tener un "catalog_key"`);
    }
  });
  
  return {
    valid: errores.length === 0,
    errors: errores
  };
}

// Actualizar estado del bot√≥n Guardar seg√∫n validaciones
function actualizarEstadoBotonGuardar() {
  const botonGuardar = document.querySelector('button[onclick="guardarMotor()"]');
  const validacion = validarTodosLosInputs();
  
  if (botonGuardar) {
    if (validacion.valid) {
      botonGuardar.disabled = false;
      botonGuardar.classList.remove('opacity-50', 'cursor-not-allowed');
      botonGuardar.classList.add('hover:bg-indigo-700');
    } else {
      botonGuardar.disabled = true;
      botonGuardar.classList.add('opacity-50', 'cursor-not-allowed');
      botonGuardar.classList.remove('hover:bg-indigo-700');
    }
  }
  
  // Mostrar errores si existen
  const erroresContainer = document.getElementById('input-errors-container');
  if (erroresContainer) {
    if (!validacion.valid && validacion.errors.length > 0) {
      erroresContainer.innerHTML = `
        <div class="bg-red-900 border border-red-600 rounded-lg p-4 mb-4">
          <h4 class="text-red-200 font-semibold mb-2">Errores de validaci√≥n:</h4>
          <ul class="list-disc list-inside text-red-300 text-sm space-y-1">
            ${validacion.errors.map(err => `<li>${err}</li>`).join('')}
          </ul>
        </div>
      `;
      erroresContainer.classList.remove('hidden');
    } else {
      erroresContainer.classList.add('hidden');
    }
  }
}
</script>

