<!-- Datos iniciales de contextos (base64 para evitar problemas de escape) -->
<script id="contexts-initial-data" type="text/plain">{{CONTEXTS_JSON}}</script>

<div class="p-6">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-white mb-2">üîß Gestor de Contextos PDE</h1>
    <p class="text-slate-400">Gestiona contextos globales (variables sem√°nticas) que usan Paquetes y Editores.</p>
  </div>

  <!-- Tabs por scope -->
  <div class="mb-6 bg-slate-800 rounded-lg shadow-lg p-4">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-white">Contextos Disponibles</h2>
      <button 
        onclick="abrirModalCrearContexto()" 
        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded transition-colors"
      >
        ‚ûï Crear Contexto
      </button>
    </div>

    <!-- Tabs por scope -->
    <div class="border-b border-slate-600 mb-4 flex flex-wrap gap-2">
      <button 
        onclick="mostrarScopeTab('system')" 
        id="tabSystem" 
        class="px-4 py-2 border-b-2 border-indigo-500 text-white font-medium"
      >
        üß† Sistema
      </button>
      <button 
        onclick="mostrarScopeTab('structural')" 
        id="tabStructural" 
        class="px-4 py-2 border-b-2 border-transparent text-slate-400 hover:text-white font-medium"
      >
        üèóÔ∏è Estructurales
      </button>
      <button 
        onclick="mostrarScopeTab('personal')" 
        id="tabPersonal" 
        class="px-4 py-2 border-b-2 border-transparent text-slate-400 hover:text-white font-medium"
      >
        üë§ Personales
      </button>
      <button 
        onclick="mostrarScopeTab('package')" 
        id="tabPackage" 
        class="px-4 py-2 border-b-2 border-transparent text-slate-400 hover:text-white font-medium"
      >
        üì¶ Package
      </button>
      <button 
        onclick="mostrarScopeTab('mappings')" 
        id="tabMappings" 
        class="px-4 py-2 border-b-2 border-transparent text-slate-400 hover:text-white font-medium"
      >
        üó∫Ô∏è Mappings
      </button>
    </div>

    <!-- Explicaci√≥n del scope -->
    <div id="scopeExplanation" class="mb-4 p-3 bg-slate-700 rounded text-sm text-slate-300">
      <!-- Se llena din√°micamente -->
    </div>

    <div id="contextsList" class="space-y-2">
      <!-- Se llena din√°micamente -->
    </div>

    <!-- Tab Mappings (solo para contextos enum) -->
    <div id="mappingsTabContent" class="hidden">
      <div class="mb-4 p-3 bg-slate-700 rounded text-sm text-slate-300">
        <strong>Context Mappings:</strong> Traduce valores de enum en par√°metros derivados reutilizables (ej: minutos, cantidades, l√≠mites).
        <br>Selecciona un contexto enum para gestionar sus mappings.
      </div>

      <!-- Selector de contexto -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-slate-300 mb-2">Contexto (solo enum)</label>
        <select 
          id="mappingContextSelector" 
          class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
          onchange="cargarMappings()"
        >
          <option value="">-- Seleccionar contexto enum --</option>
        </select>
      </div>

      <!-- Lista de mappings -->
      <div id="mappingsList" class="space-y-2">
        <!-- Se llena din√°micamente -->
      </div>
    </div>
  </div>
</div>

<!-- Modal para crear/editar contexto -->
<div id="contextModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-slate-800 rounded-lg shadow-xl p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-white" id="modalTitle">Crear Nuevo Contexto</h2>
      <button 
        onclick="cerrarModalContexto()" 
        class="text-slate-400 hover:text-white text-2xl"
      >
        √ó
      </button>
    </div>

    <!-- Tabs: Visual / Avanzado -->
    <div class="mb-4 border-b border-slate-600">
      <button onclick="mostrarTab('visual')" id="tabVisual" class="px-4 py-2 border-b-2 border-indigo-500 text-white font-medium">üìù Visual</button>
      <button onclick="mostrarTab('avanzado')" id="tabAvanzado" class="px-4 py-2 border-b-2 border-transparent text-slate-400 hover:text-white">‚öôÔ∏è Avanzado (JSON)</button>
    </div>

    <!-- Tab Visual -->
    <div id="tabVisualContent">
      <div class="mb-4">
        <label class="block text-sm font-medium text-slate-300 mb-2">Context Key <span class="text-red-400">*</span></label>
        <input 
          type="text" 
          id="contextKey" 
          required
          class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"
          placeholder="nivel_efectivo"
          oninput="validarContextKey(this)"
        />
        <div id="contextKeyError" class="mt-1 text-sm text-red-400 hidden"></div>
        <p class="text-xs text-slate-500 mt-1">Solo letras min√∫sculas, n√∫meros, guiones bajos y guiones</p>
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-slate-300 mb-2">Label <span class="text-red-400">*</span></label>
        <input 
          type="text" 
          id="contextLabel" 
          required
          class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="Nivel Efectivo"
        />
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-slate-300 mb-2">Descripci√≥n</label>
        <textarea 
          id="contextDescription" 
          rows="2"
          class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="Descripci√≥n opcional del contexto"
        ></textarea>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-slate-300 mb-2">Tipo <span class="text-red-400">*</span></label>
        <select 
          id="contextType" 
          required
          class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
          onchange="actualizarInputsPorTipo()"
        >
          <option value="string">String (texto)</option>
          <option value="number">Number (n√∫mero)</option>
          <option value="boolean">Boolean (verdadero/falso)</option>
          <option value="enum">Enum (lista de valores)</option>
          <option value="json">JSON (objeto)</option>
        </select>
      </div>

      <!-- Default Value (din√°mico seg√∫n type) -->
      <div class="mb-4" id="defaultValueContainer">
        <label class="block text-sm font-medium text-slate-300 mb-2">Valor por Defecto</label>
        <div id="defaultValueInput">
          <!-- Se llena din√°micamente seg√∫n type -->
        </div>
      </div>

      <!-- Allowed Values (solo para enum) -->
      <div class="mb-4 hidden" id="allowedValuesContainer">
        <label class="block text-sm font-medium text-slate-300 mb-2">Valores Permitidos <span class="text-red-400">*</span> (uno por l√≠nea)</label>
        <textarea 
          id="allowedValues" 
          rows="4"
          class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"
          placeholder="rapida&#10;basica&#10;profunda&#10;maestro"
        ></textarea>
        <p class="text-xs text-slate-500 mt-1">Escribe un valor por l√≠nea</p>
      </div>

      <!-- Scope, Kind, Injected -->
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Scope <span class="text-red-400">*</span></label>
          <select 
            id="contextScope" 
            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
            onchange="actualizarScopeEnFormulario()"
          >
            <option value="package">Package</option>
            <option value="system">System</option>
            <option value="structural">Structural</option>
            <option value="personal">Personal</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">
            <strong>Package:</strong> Definido por experiencia<br>
            <strong>System:</strong> Global del sistema<br>
            <strong>Structural:</strong> Estado estructural<br>
            <strong>Personal:</strong> Estado personal
          </p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Kind</label>
          <select 
            id="contextKind" 
            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
            <option value="normal">Normal</option>
            <option value="level">Level</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">
            <strong>Normal:</strong> Contexto est√°ndar<br>
            <strong>Level:</strong> Contexto de nivel
          </p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Injected</label>
          <div class="mt-2">
            <label class="flex items-center gap-2 text-slate-300">
              <input 
                type="checkbox" 
                id="contextInjected" 
                class="w-4 h-4"
              />
              El runtime lo inyecta autom√°ticamente
            </label>
          </div>
          <p class="text-xs text-slate-500 mt-1">
            Si est√° marcado, el runtime inyecta este contexto autom√°ticamente
          </p>
        </div>
      </div>

      <!-- Origin (legacy, mantener para compatibilidad) -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-slate-300 mb-2">Origin (legacy)</label>
        <select 
          id="contextOrigin" 
          class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
        >
          <option value="user_choice">User Choice</option>
          <option value="system">System</option>
          <option value="derived">Derived</option>
        </select>
        <p class="text-xs text-slate-500 mt-1">Campo legacy, se mantiene para compatibilidad</p>
      </div>

      <!-- UI Config (opcional) -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-slate-300 mb-2">Configuraci√≥n UI (JSON opcional)</label>
        <textarea 
          id="uiConfig" 
          rows="4"
          class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"
          placeholder='{"placeholder": "Ejemplo...", "help_text": "Texto de ayuda", "order": 1, "hidden": false}'
        ></textarea>
        <p class="text-xs text-slate-500 mt-1">Opcional: placeholder, help_text, order, hidden</p>
      </div>
    </div>

    <!-- Tab Avanzado (JSON) -->
    <div id="tabAvanzadoContent" class="hidden">
      <div class="mb-4">
        <label class="block text-sm font-medium text-slate-300 mb-2">Definition (JSON completo)</label>
        <textarea 
          id="contextDefinition" 
          rows="15"
          class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"
          placeholder='{"type": "number", "default_value": 1, "scope": "global", "origin": "system", "description": "..."}'
          onchange="sincronizarDesdeJSON()"
        ></textarea>
        <p class="text-xs text-slate-500 mt-1">Edita el JSON completo. Los cambios se sincronizan con el formulario visual.</p>
      </div>
    </div>
    
    <div class="flex gap-2 mt-6">
      <button 
        onclick="guardarContexto()" 
        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded transition-colors"
      >
        üíæ Guardar Contexto
      </button>
      <button 
        onclick="cerrarModalContexto()" 
        class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white font-medium rounded transition-colors"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>

<script>
// Datos globales
let contexts = [];
let editingContextKey = null;
let currentScopeTab = 'system'; // Tab activo: 'system' o 'recorrido'

// Cargar contextos al iniciar
document.addEventListener('DOMContentLoaded', async () => {
  // Limpiar cualquier cache local previo
  if (typeof localStorage !== 'undefined') {
    localStorage.removeItem('pde_contexts');
    localStorage.removeItem('contexts_cache');
  }
  if (typeof sessionStorage !== 'undefined') {
    sessionStorage.removeItem('pde_contexts');
    sessionStorage.removeItem('contexts_cache');
  }
  
  // Cargar contextos iniciales desde el servidor (sin cache)
  await recargarContextosDesdeServidor();
  mostrarScopeTab('package'); // Mostrar tab de package por defecto
  // Pre-cargar contextos enum para el selector de mappings
  cargarContextosEnum();
});

// Recargar contextos desde el servidor (siempre fresh, sin cache)
async function recargarContextosDesdeServidor() {
  try {
    const response = await fetch('/admin/api/contexts', {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
      cache: 'no-store'  // Forzar fetch fresh
    });
    
    if (response.ok) {
      const responseText = await response.text();
      try {
        const data = JSON.parse(responseText);
        contexts = data.contexts || [];
      } catch (parseError) {
        console.error('Error: Respuesta del servidor no es JSON v√°lido al recargar contextos');
        console.error('Respuesta recibida:', responseText.substring(0, 500));
        contexts = [];
      }
    } else {
      // Fallback: leer desde script tag con base64
      try {
        const scriptTag = document.getElementById('contexts-initial-data');
        if (scriptTag && scriptTag.textContent) {
          const decoded = atob(scriptTag.textContent);
          contexts = JSON.parse(decoded);
        } else {
          contexts = [];
        }
      } catch (e) {
        console.error('Error en fallback de contextos:', e);
        contexts = [];
      }
    }
  } catch (error) {
    console.error('Error recargando contextos:', error);
    // Fallback: leer desde script tag con base64
    try {
      const scriptTag = document.getElementById('contexts-initial-data');
      if (scriptTag && scriptTag.textContent) {
        const decoded = atob(scriptTag.textContent);
        contexts = JSON.parse(decoded);
      } else {
        contexts = [];
      }
    } catch (e) {
      console.error('Error en fallback de contextos:', e);
      contexts = [];
    }
  }
}

// Mostrar tab por scope
function mostrarScopeTab(scope) {
  currentScopeTab = scope;
  
  // Resetear todos los tabs
  const tabs = ['tabSystem', 'tabStructural', 'tabPersonal', 'tabPackage', 'tabMappings'];
  tabs.forEach(tabId => {
    const tab = document.getElementById(tabId);
    if (tab) {
      tab.classList.remove('border-indigo-500', 'text-white');
      tab.classList.add('border-transparent', 'text-slate-400');
    }
  });
  
  // Activar tab seleccionado
  const activeTabId = scope === 'system' ? 'tabSystem' :
                      scope === 'structural' ? 'tabStructural' :
                      scope === 'personal' ? 'tabPersonal' :
                      scope === 'package' ? 'tabPackage' :
                      'tabMappings';
  const activeTab = document.getElementById(activeTabId);
  if (activeTab) {
    activeTab.classList.add('border-indigo-500', 'text-white');
    activeTab.classList.remove('border-transparent', 'text-slate-400');
  }
  
  // Mostrar/ocultar contenido
  if (scope === 'mappings') {
    document.getElementById('contextsList').classList.add('hidden');
    document.getElementById('mappingsTabContent').classList.remove('hidden');
    cargarContextosEnum();
  } else {
    document.getElementById('contextsList').classList.remove('hidden');
    document.getElementById('mappingsTabContent').classList.add('hidden');
    
    // Actualizar explicaci√≥n seg√∫n scope
    const explanations = {
      'system': 'Contextos de Sistema: Variables globales del sistema (ej: temporada). Inyectados autom√°ticamente por el runtime.',
      'structural': 'Contextos Estructurales: Estado estructural del alumno (ej: nivel_pde). Inyectados autom√°ticamente.',
      'personal': 'Contextos Personales: Estado personal variable del alumno. No inyectados autom√°ticamente.',
      'package': 'Contextos de Package: Definidos por experiencias concretas. Aparecen en el selector del creador de paquetes.'
    };
    const explanationEl = document.getElementById('scopeExplanation');
    explanationEl.textContent = '';
    const strongEl = document.createElement('strong');
    strongEl.textContent = explanations[scope] || '';
    explanationEl.appendChild(strongEl);
    renderContexts();
  }
}

// Actualizar formulario cuando cambia scope
function actualizarScopeEnFormulario() {
  const scope = document.getElementById('contextScope').value;
  const kindSelect = document.getElementById('contextKind');
  const injectedCheckbox = document.getElementById('contextInjected');
  
  // Validaciones: impedir errores conceptuales
  // nivel_pde debe ser structural + level + injected
  const contextKey = document.getElementById('contextKey').value;
  if (contextKey === 'nivel_pde') {
    if (scope !== 'structural') {
      alert('‚ö†Ô∏è nivel_pde DEBE tener scope=structural');
      document.getElementById('contextScope').value = 'structural';
    }
    if (kindSelect.value !== 'level') {
      alert('‚ö†Ô∏è nivel_pde DEBE tener kind=level');
      kindSelect.value = 'level';
    }
    if (!injectedCheckbox.checked) {
      alert('‚ö†Ô∏è nivel_pde DEBE tener injected=true');
      injectedCheckbox.checked = true;
    }
  }
  
  // Si es system o structural, normalmente injected=true
  if ((scope === 'system' || scope === 'structural') && !injectedCheckbox.checked) {
    // Sugerir pero no forzar
    console.log(`Sugerencia: contextos ${scope} normalmente tienen injected=true`);
  }
  
  // Si es package, normalmente injected=false
  if (scope === 'package' && injectedCheckbox.checked) {
    console.log(`Sugerencia: contextos package normalmente tienen injected=false`);
  }
}

// Validaci√≥n de context_key
function validarContextKey(input) {
  const contextKey = input.value;
  const errorDiv = document.getElementById('contextKeyError');
  const contextKeyRegex = /^[a-z0-9_-]+$/;
  
  if (!contextKey) {
    errorDiv.classList.add('hidden');
    input.classList.remove('border-red-500');
    return true;
  }
  
  if (!contextKeyRegex.test(contextKey)) {
    errorDiv.textContent = 'Solo se permiten letras min√∫sculas, n√∫meros, guiones bajos (_) y guiones (-)';
    errorDiv.classList.remove('hidden');
    input.classList.add('border-red-500');
    return false;
  }
  
  errorDiv.classList.add('hidden');
  input.classList.remove('border-red-500');
  return true;
}

// Renderizar lista de contextos (filtrado por scope)
function renderContexts() {
  const container = document.getElementById('contextsList');
  if (!container) return;

  // Limpiar contenedor
  container.textContent = '';

  // Filtrar contextos por scope activo
  const scope = currentScopeTab;
  const filteredContexts = contexts.filter(ctx => {
    const ctxScope = ctx.scope || ctx.definition?.scope || 'package';
    // Mapear 'recorrido' legacy a 'package'
    const normalizedScope = ctxScope === 'recorrido' ? 'package' : ctxScope;
    return normalizedScope === scope;
  });

  if (filteredContexts.length === 0) {
    const emptyMsg = document.createElement('p');
    emptyMsg.className = 'text-slate-400';
    emptyMsg.textContent = `No hay contextos de tipo "${scope}" disponibles`;
    container.appendChild(emptyMsg);
    return;
  }

  filteredContexts.forEach(ctx => {
    const def = ctx.definition || {};
    const ctxScope = ctx.scope || def.scope || 'package';
    const ctxKind = ctx.kind || def.kind || 'normal';
    const ctxInjected = ctx.injected !== undefined ? ctx.injected : (def.injected !== undefined ? def.injected : false);
    const ctxType = ctx.type || def.type || 'string';
    
    // Contenedor principal
    const card = document.createElement('div');
    card.className = 'bg-slate-700 rounded p-4 flex justify-between items-start';
    
    // Contenedor izquierdo
    const leftDiv = document.createElement('div');
    leftDiv.className = 'flex-1';
    
    // Header con label y badges
    const headerDiv = document.createElement('div');
    headerDiv.className = 'flex items-center gap-2 mb-2';
    
    const h3 = document.createElement('h3');
    h3.className = 'text-lg font-semibold text-white';
    h3.textContent = ctx.label || ctx.context_key;
    headerDiv.appendChild(h3);
    
    // Badge de scope
    const scopeBadge = document.createElement('span');
    scopeBadge.className = 'text-xs px-2 py-1 rounded text-white';
    scopeBadge.textContent = ctxScope.toUpperCase();
    if (ctxScope === 'system') {
      scopeBadge.classList.add('bg-purple-600');
    } else if (ctxScope === 'structural') {
      scopeBadge.classList.add('bg-orange-600');
    } else if (ctxScope === 'personal') {
      scopeBadge.classList.add('bg-pink-600');
    } else {
      scopeBadge.classList.add('bg-indigo-600');
    }
    headerDiv.appendChild(scopeBadge);
    
    // Badge LEVEL
    if (ctxKind === 'level') {
      const levelBadge = document.createElement('span');
      levelBadge.className = 'text-xs px-2 py-1 rounded bg-yellow-600 text-white';
      levelBadge.textContent = 'LEVEL';
      headerDiv.appendChild(levelBadge);
    }
    
    // Badge INJECTED
    if (ctxInjected) {
      const injectedBadge = document.createElement('span');
      injectedBadge.className = 'text-xs px-2 py-1 rounded bg-green-600 text-white';
      injectedBadge.textContent = 'INJECTED';
      headerDiv.appendChild(injectedBadge);
    }
    
    // Code con context_key
    const codeEl = document.createElement('code');
    codeEl.className = 'text-xs text-slate-400';
    codeEl.textContent = ctx.context_key;
    headerDiv.appendChild(codeEl);
    
    leftDiv.appendChild(headerDiv);
    
    // Informaci√≥n del contexto
    const infoDiv = document.createElement('div');
    infoDiv.className = 'text-sm text-slate-300';
    
    // Tipo
    const tipoP = document.createElement('p');
    const tipoStrong = document.createElement('strong');
    tipoStrong.textContent = 'Tipo:';
    tipoP.appendChild(tipoStrong);
    tipoP.appendChild(document.createTextNode(' ' + ctxType));
    infoDiv.appendChild(tipoP);
    
    // Default value
    const defaultValue = ctx.default_value !== undefined ? ctx.default_value : def.default_value;
    if (defaultValue !== null && defaultValue !== undefined) {
      const defaultP = document.createElement('p');
      const defaultStrong = document.createElement('strong');
      defaultStrong.textContent = 'Default:';
      defaultP.appendChild(defaultStrong);
      defaultP.appendChild(document.createTextNode(' ' + JSON.stringify(defaultValue)));
      infoDiv.appendChild(defaultP);
    }
    
    // Descripci√≥n
    const description = ctx.description || def.description;
    if (description) {
      const descP = document.createElement('p');
      const descStrong = document.createElement('strong');
      descStrong.textContent = 'Descripci√≥n:';
      descP.appendChild(descStrong);
      descP.appendChild(document.createTextNode(' ' + description));
      infoDiv.appendChild(descP);
    }
    
    leftDiv.appendChild(infoDiv);
    card.appendChild(leftDiv);
    
    // Botones
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'flex gap-2';
    
    const editBtn = document.createElement('button');
    editBtn.className = 'px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition-colors';
    editBtn.textContent = '‚úèÔ∏è Editar';
    editBtn.onclick = () => editarContexto(ctx.context_key);
    buttonsDiv.appendChild(editBtn);
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-colors';
    deleteBtn.textContent = 'üóëÔ∏è Eliminar';
    deleteBtn.onclick = () => eliminarContexto(ctx.context_key, deleteBtn);
    buttonsDiv.appendChild(deleteBtn);
    
    card.appendChild(buttonsDiv);
    container.appendChild(card);
  });
}

// Mostrar tab
function mostrarTab(tab) {
  if (tab === 'visual') {
    document.getElementById('tabVisual').classList.add('border-indigo-500', 'text-white');
    document.getElementById('tabVisual').classList.remove('border-transparent', 'text-slate-400');
    document.getElementById('tabAvanzado').classList.remove('border-indigo-500', 'text-white');
    document.getElementById('tabAvanzado').classList.add('border-transparent', 'text-slate-400');
    document.getElementById('tabVisualContent').classList.remove('hidden');
    document.getElementById('tabAvanzadoContent').classList.add('hidden');
  } else {
    document.getElementById('tabAvanzado').classList.add('border-indigo-500', 'text-white');
    document.getElementById('tabAvanzado').classList.remove('border-transparent', 'text-slate-400');
    document.getElementById('tabVisual').classList.remove('border-indigo-500', 'text-white');
    document.getElementById('tabVisual').classList.add('border-transparent', 'text-slate-400');
    document.getElementById('tabAvanzadoContent').classList.remove('hidden');
    document.getElementById('tabVisualContent').classList.add('hidden');
    sincronizarHaciaJSON();
  }
}

// Actualizar inputs seg√∫n tipo
function actualizarInputsPorTipo() {
  const type = document.getElementById('contextType').value;
  const container = document.getElementById('defaultValueInput');
  const allowedContainer = document.getElementById('allowedValuesContainer');

  // Mostrar/ocultar allowed values
  if (type === 'enum') {
    allowedContainer.classList.remove('hidden');
  } else {
    allowedContainer.classList.add('hidden');
  }

  // Crear input seg√∫n tipo
  let html = '';
  switch (type) {
    case 'string':
      html = '<input type="text" id="defaultValue" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Valor por defecto" />';
      break;
    case 'number':
      html = '<input type="number" id="defaultValue" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0" />';
      break;
    case 'boolean':
      html = '<select id="defaultValue" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="false">Falso</option><option value="true">Verdadero</option></select>';
      break;
    case 'enum':
      html = '<select id="defaultValue" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="">-- Seleccionar --</option></select>';
      break;
    case 'json':
      html = '<textarea id="defaultValue" rows="3" class="w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm" placeholder="{}"></textarea>';
      break;
  }
  container.innerHTML = html;
}

// Sincronizar desde formulario visual hacia JSON
function sincronizarHaciaJSON() {
  const type = document.getElementById('contextType').value;
  let defaultValue = null;

  // Obtener default value seg√∫n tipo
  const defaultValueEl = document.getElementById('defaultValue');
  if (defaultValueEl) {
    if (type === 'number') {
      const val = defaultValueEl.value;
      defaultValue = val === '' ? null : parseFloat(val);
    } else if (type === 'boolean') {
      defaultValue = defaultValueEl.value === 'true';
    } else if (type === 'json') {
      try {
        defaultValue = defaultValueEl.value ? JSON.parse(defaultValueEl.value) : {};
      } catch (e) {
        defaultValue = {};
      }
    } else if (type === 'enum') {
      defaultValue = defaultValueEl.value || null;
    } else {
      defaultValue = defaultValueEl.value || '';
    }
  }

  // Obtener allowed_values
  let allowedValues = [];
  if (type === 'enum') {
    const allowedText = document.getElementById('allowedValues').value;
    allowedValues = allowedText.split('\n').map(v => v.trim()).filter(v => v);
  }

  // Obtener ui_config
  let uiConfig = {};
  const uiConfigText = document.getElementById('uiConfig').value;
  if (uiConfigText.trim()) {
    try {
      uiConfig = JSON.parse(uiConfigText);
    } catch (e) {
      uiConfig = {};
    }
  }

  const definition = {
    type,
    default_value: defaultValue,
    scope: document.getElementById('contextScope').value,
    kind: document.getElementById('contextKind').value,
    injected: document.getElementById('contextInjected').checked,
    origin: document.getElementById('contextOrigin').value,
    description: document.getElementById('contextDescription').value || ''
  };

  if (type === 'enum' && allowedValues.length > 0) {
    definition.allowed_values = allowedValues;
  }

  if (Object.keys(uiConfig).length > 0) {
    definition.ui_config = uiConfig;
  }

  document.getElementById('contextDefinition').value = JSON.stringify(definition, null, 2);
}

// Sincronizar desde JSON hacia formulario visual
function sincronizarDesdeJSON() {
  try {
    const definition = JSON.parse(document.getElementById('contextDefinition').value);
    
    document.getElementById('contextType').value = definition.type || 'string';
    document.getElementById('contextScope').value = definition.scope || 'package';
    document.getElementById('contextKind').value = definition.kind || 'normal';
    document.getElementById('contextInjected').checked = definition.injected !== undefined ? definition.injected : false;
    document.getElementById('contextOrigin').value = definition.origin || 'user_choice';
    document.getElementById('contextDescription').value = definition.description || '';
    
    // Actualizar validaciones
    actualizarScopeEnFormulario();
    
    if (definition.ui_config) {
      document.getElementById('uiConfig').value = JSON.stringify(definition.ui_config, null, 2);
    } else {
      document.getElementById('uiConfig').value = '';
    }

    actualizarInputsPorTipo();

    // Establecer default value
    setTimeout(() => {
      const defaultValueEl = document.getElementById('defaultValue');
      if (defaultValueEl && definition.default_value !== undefined && definition.default_value !== null) {
        if (definition.type === 'json') {
          defaultValueEl.value = JSON.stringify(definition.default_value, null, 2);
        } else {
          defaultValueEl.value = definition.default_value;
        }
      }
    }, 100);

    // Establecer allowed values
    if (definition.type === 'enum' && definition.allowed_values) {
      document.getElementById('allowedValues').value = definition.allowed_values.join('\n');
    }
  } catch (e) {
    // Ignorar errores de parseo
  }
}

// Abrir modal para crear contexto
function abrirModalCrearContexto() {
  editingContextKey = null;
  document.getElementById('modalTitle').textContent = 'Crear Nuevo Contexto';
  document.getElementById('contextKey').value = '';
  document.getElementById('contextKey').disabled = false;
  document.getElementById('contextLabel').value = '';
  document.getElementById('contextDescription').value = '';
  document.getElementById('contextType').value = 'string';
  document.getElementById('contextScope').value = 'package';
  document.getElementById('contextKind').value = 'normal';
  document.getElementById('contextInjected').checked = false;
  document.getElementById('contextOrigin').value = 'user_choice';
  document.getElementById('uiConfig').value = '';
  document.getElementById('allowedValues').value = '';
  
  actualizarScopeEnFormulario();
  actualizarInputsPorTipo();
  
  const defaultValueEl = document.getElementById('defaultValue');
  if (defaultValueEl) defaultValueEl.value = '';

  document.getElementById('contextDefinition').value = JSON.stringify({
    type: 'string',
    default_value: '',
    scope: 'package',
    kind: 'normal',
    injected: false,
    origin: 'user_choice',
    description: ''
  }, null, 2);

  mostrarTab('visual');
  document.getElementById('contextModal').classList.remove('hidden');
}

// Cerrar modal
function cerrarModalContexto() {
  document.getElementById('contextModal').classList.add('hidden');
  editingContextKey = null;
}

// Editar contexto
function editarContexto(contextKey) {
  const ctx = contexts.find(c => c.context_key === contextKey);
  if (!ctx) return;

  editingContextKey = contextKey;
  const isSystem = ctx.is_system || false;
  document.getElementById('modalTitle').textContent = isSystem ? 'Editar Contexto (Sistema)' : 'Editar Contexto';
  document.getElementById('contextKey').value = ctx.context_key;
  document.getElementById('contextKey').disabled = isSystem; // No editable si es sistema
  document.getElementById('contextLabel').value = ctx.label;
  
  const def = ctx.definition || {};
  document.getElementById('contextType').value = ctx.type || def.type || 'string';
  document.getElementById('contextScope').value = ctx.scope || def.scope || 'package';
  document.getElementById('contextKind').value = ctx.kind || def.kind || 'normal';
  document.getElementById('contextInjected').checked = ctx.injected !== undefined ? ctx.injected : (def.injected !== undefined ? def.injected : false);
  document.getElementById('contextOrigin').value = def.origin || 'user_choice';
  document.getElementById('contextDescription').value = ctx.description || def.description || '';
  
  // Actualizar validaciones
  actualizarScopeEnFormulario();
  
  if (def.ui_config) {
    document.getElementById('uiConfig').value = JSON.stringify(def.ui_config, null, 2);
  } else {
    document.getElementById('uiConfig').value = '';
  }

  actualizarInputsPorTipo();

  // Establecer default value
  setTimeout(() => {
    const defaultValueEl = document.getElementById('defaultValue');
    if (defaultValueEl && def.default_value !== undefined && def.default_value !== null) {
      if (def.type === 'json') {
        defaultValueEl.value = JSON.stringify(def.default_value, null, 2);
      } else {
        defaultValueEl.value = def.default_value;
      }
    }
  }, 100);

    // Establecer allowed values
    if (def.type === 'enum' && def.allowed_values) {
      document.getElementById('allowedValues').value = def.allowed_values.join('\n');
      // Actualizar select de default con allowed values
      setTimeout(() => {
        const defaultValueEl = document.getElementById('defaultValue');
        if (defaultValueEl && defaultValueEl.tagName === 'SELECT') {
          defaultValueEl.textContent = '';
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = '-- Seleccionar --';
          defaultValueEl.appendChild(defaultOption);
          def.allowed_values.forEach(v => {
            const option = document.createElement('option');
            option.value = v;
            option.textContent = v;
            if (v === def.default_value) {
              option.selected = true;
            }
            defaultValueEl.appendChild(option);
          });
        }
      }, 150);
    }

  document.getElementById('contextDefinition').value = JSON.stringify(def, null, 2);
  mostrarTab('visual');
  document.getElementById('contextModal').classList.remove('hidden');
}

// Guardar contexto
async function guardarContexto() {
  // Sincronizar desde formulario visual hacia JSON antes de guardar
  sincronizarHaciaJSON();

  const contextKey = document.getElementById('contextKey').value;
  const label = document.getElementById('contextLabel').value;
  const definitionText = document.getElementById('contextDefinition').value;

  if (!contextKey || !label || !definitionText) {
    alert('Context Key, Label y Definition son obligatorios');
    return;
  }

  // Validar context_key
  const contextKeyRegex = /^[a-z0-9_-]+$/;
  if (!contextKeyRegex.test(contextKey)) {
    alert('Context Key inv√°lido: Solo se permiten letras min√∫sculas, n√∫meros, guiones bajos (_) y guiones (-)');
    return;
  }

  // Validar JSON
  let definition;
  try {
    definition = JSON.parse(definitionText);
  } catch (error) {
    alert('JSON inv√°lido: ' + error.message);
    return;
  }

  try {
    // DEFINIR URL EXPL√çCITAMENTE: construcci√≥n can√≥nica y robusta
    const isEdit = Boolean(editingContextKey);
    // En edici√≥n, usar editingContextKey como identificador (contextKey puede haber cambiado en el input)
    const contextKeyForUrl = isEdit ? editingContextKey : contextKey;
    const url = isEdit
      ? `/admin/api/contexts/${encodeURIComponent(contextKeyForUrl)}`
      : '/admin/api/contexts';
    const method = isEdit ? 'PUT' : 'POST';

    // Obtener campos can√≥nicos del formulario
    const scope = document.getElementById('contextScope').value;
    const kind = document.getElementById('contextKind').value;
    const injected = document.getElementById('contextInjected').checked;
    const type = document.getElementById('contextType').value;
    const description = document.getElementById('contextDescription').value || null;
    
    // Obtener allowed_values y default_value
    let allowedValues = undefined;
    let defaultValue = undefined;
    
    if (type === 'enum') {
      const allowedText = document.getElementById('allowedValues').value;
      allowedValues = allowedText.split('\n').map(v => v.trim()).filter(v => v);
    }
    
    // BLINDAR parseo de default_value para evitar excepciones JS
    const defaultValueEl = document.getElementById('defaultValue');
    if (defaultValueEl) {
      if (type === 'number') {
        const val = defaultValueEl.value;
        defaultValue = val === '' ? undefined : parseFloat(val);
        // Validar que parseFloat no devuelva NaN
        if (isNaN(defaultValue)) {
          defaultValue = undefined;
        }
      } else if (type === 'boolean') {
        defaultValue = defaultValueEl.value === 'true';
      } else if (type === 'json') {
        // Parseo blindado: nunca debe lanzar excepci√≥n
        try {
          defaultValue = defaultValueEl.value
            ? JSON.parse(defaultValueEl.value)
            : undefined;
        } catch (e) {
          console.warn('[PDE][CONTEXTS] Error parseando default_value JSON:', e.message);
          defaultValue = undefined;
        }
      } else if (type === 'enum') {
        defaultValue = defaultValueEl.value || undefined;
      } else {
        defaultValue = defaultValueEl.value || undefined;
      }
    }

    // Construir payload can√≥nico (SOLO campos permitidos)
    const payload = {
      context_key: contextKey,
      label,
      definition,
      scope,
      kind,
      type,
      injected
    };

    // A√±adir description solo si est√° definido
    if (description) {
      payload.description = description;
    }

    // A√±adir allowed_values solo si est√° definido (para tipo enum)
    if (allowedValues !== undefined && allowedValues.length > 0) {
      payload.allowed_values = allowedValues;
    }

    // A√±adir default_value solo si est√° definido
    if (defaultValue !== undefined) {
      payload.default_value = defaultValue;
    }

    // Log defensivo antes del fetch
    console.debug('[PDE][CONTEXTS] Saving context', { url, method, payload });

    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    // Leer primero como texto para validar
    const responseText = await response.text();
    
    // Verificar si es JSON v√°lido
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error('Error: Respuesta del servidor no es JSON v√°lido');
      console.error('Status:', response.status);
      console.error('Content-Type:', response.headers.get('content-type'));
      console.error('Respuesta recibida (primeros 500 chars):', responseText.substring(0, 500));
      alert('Error: El servidor devolvi√≥ una respuesta inv√°lida. Ver consola para m√°s detalles.');
      return;
    }

    if (!data.ok) {
      alert('Error: ' + (data.error || 'Error desconocido'));
      return;
    }

    // Recargar contextos desde el servidor (sin cache)
    await recargarContextosDesdeServidor();
    renderContexts();

    cerrarModalContexto();
    alert('Contexto guardado exitosamente');
  } catch (error) {
    console.error('Error guardando contexto:', error);
    alert('Error al guardar contexto: ' + (error.message || 'Error desconocido'));
  }
}

// Eliminar contexto
async function eliminarContexto(contextKey, buttonElement) {
  // Confirmaci√≥n con m√°s informaci√≥n
  const ctx = contexts.find(c => c.context_key === contextKey);
  const ctxLabel = ctx ? ctx.label : contextKey;
  if (!confirm(`¬øEst√°s seguro de eliminar el contexto '${ctxLabel}' (${contextKey})?\n\nEsta acci√≥n no se puede deshacer.`)) {
    return;
  }

  try {
    // Mostrar indicador de carga
    let originalText = '';
    if (buttonElement) {
      originalText = buttonElement.textContent;
      buttonElement.disabled = true;
      buttonElement.textContent = '‚è≥ Eliminando...';
      buttonElement.classList.add('opacity-50');
    }
    
    const response = await fetch(`/admin/api/contexts/${encodeURIComponent(contextKey)}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });

    // Leer primero como texto
    const responseText = await response.text();
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error('Error: Respuesta del servidor no es JSON v√°lido');
      console.error('Status:', response.status);
      console.error('Respuesta recibida:', responseText.substring(0, 500));
      if (buttonElement) {
        buttonElement.disabled = false;
        buttonElement.textContent = originalText;
        buttonElement.classList.remove('opacity-50');
      }
      alert('Error: El servidor devolvi√≥ una respuesta inv√°lida. Ver consola.');
      return;
    }

    if (!data.ok) {
      if (buttonElement) {
        buttonElement.disabled = false;
        buttonElement.textContent = originalText;
        buttonElement.classList.remove('opacity-50');
      }
      alert('‚ùå Error: ' + (data.error || 'Error desconocido'));
      return;
    }

    // Recargar contextos desde el servidor (sin cache)
    await recargarContextosDesdeServidor();
    // Re-renderizar la lista para reflejar los cambios
    renderContexts();
    // Mostrar mensaje de √©xito
    showToast('‚úÖ Contexto eliminado exitosamente', 'success');
  } catch (error) {
    console.error('Error eliminando contexto:', error);
    alert('‚ùå Error al eliminar contexto: ' + (error.message || 'Error desconocido'));
    
    // Restaurar bot√≥n si existe
    if (buttonElement) {
      buttonElement.disabled = false;
      buttonElement.textContent = 'üóëÔ∏è Eliminar';
      buttonElement.classList.remove('opacity-50');
    }
  }
}

// Helper para mostrar toast de √©xito/error
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: ${type === 'success' ? '#10b981' : '#ef4444'};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 10000;
    font-size: 0.875rem;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  // Animar entrada
  setTimeout(() => {
    toast.style.opacity = '1';
    toast.style.transform = 'translateY(0)';
  }, 10);
  
  // Remover despu√©s de 3 segundos
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(10px)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Helper para escapar HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============================================
// FUNCIONES PARA MAPPINGS
// ============================================

// Cargar contextos enum en el selector
async function cargarContextosEnum() {
  const selector = document.getElementById('mappingContextSelector');
  if (!selector) return;

  // Filtrar solo contextos enum
  const enumContexts = contexts.filter(ctx => {
    const def = ctx.definition || {};
    return def.type === 'enum' && def.allowed_values && def.allowed_values.length > 0;
  });

  // Limpiar selector
  selector.textContent = '';
  
  // Opci√≥n por defecto
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = '-- Seleccionar contexto enum --';
  selector.appendChild(defaultOption);
  
  // Agregar contextos enum
  enumContexts.forEach(ctx => {
    const option = document.createElement('option');
    option.value = ctx.context_key;
    option.textContent = `${ctx.label} (${ctx.context_key})`;
    selector.appendChild(option);
  });

  // Si hay un contexto seleccionado, cargar sus mappings
  if (selector.value) {
    await cargarMappings();
  }
}

// Cargar mappings del contexto seleccionado
async function cargarMappings() {
  const selector = document.getElementById('mappingContextSelector');
  const contextKey = selector.value;
  const container = document.getElementById('mappingsList');
  
  // Limpiar contenedor
  container.textContent = '';
  
  if (!contextKey) {
    const msg = document.createElement('p');
    msg.className = 'text-slate-400';
    msg.textContent = 'Selecciona un contexto enum';
    container.appendChild(msg);
    return;
  }

  try {
    const response = await fetch(`/admin/api/context-mappings?context_key=${encodeURIComponent(contextKey)}`);
    
    // Leer primero como texto
    const responseText = await response.text();
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error('Error: Respuesta del servidor no es JSON v√°lido');
      console.error('Status:', response.status);
      console.error('Respuesta recibida:', responseText.substring(0, 500));
      const errorMsg = document.createElement('p');
      errorMsg.className = 'text-red-400';
      errorMsg.textContent = 'Error: El servidor devolvi√≥ una respuesta inv√°lida. Ver consola.';
      container.appendChild(errorMsg);
      return;
    }

    if (!data.ok) {
      const errorMsg = document.createElement('p');
      errorMsg.className = 'text-red-400';
      errorMsg.textContent = `Error: ${data.error || 'Error desconocido'}`;
      container.appendChild(errorMsg);
      return;
    }

    const mappings = data.mappings || [];
    const context = contexts.find(c => c.context_key === contextKey);
    const def = context?.definition || {};
    const allowedValues = def.allowed_values || [];

    // Mostrar warnings si existen
    if (data.warnings && data.warnings.length > 0) {
      const warningDiv = document.createElement('div');
      warningDiv.className = 'mb-4 p-3 bg-yellow-900 border border-yellow-600 rounded text-yellow-200 text-sm';
      const strongEl = document.createElement('strong');
      strongEl.textContent = '‚ö†Ô∏è Advertencias:';
      warningDiv.appendChild(strongEl);
      const br = document.createElement('br');
      warningDiv.appendChild(br);
      data.warnings.forEach((w, idx) => {
        if (idx > 0) {
          const br2 = document.createElement('br');
          warningDiv.appendChild(br2);
        }
        const warningText = document.createTextNode(w);
        warningDiv.appendChild(warningText);
      });
      container.appendChild(warningDiv);
    }

    // Crear un mapping para cada valor permitido (si no existe, mostrar placeholder)
    const mappingsMap = new Map(mappings.map(m => [m.mapping_key, m]));

    allowedValues.forEach((value, index) => {
      const mapping = mappingsMap.get(value);
      const mappingId = mapping ? mapping.id : null;
      const mappingLabel = mapping ? (mapping.label || value) : value;
      const mappingDescription = mapping ? (mapping.description || '') : '';
      const mappingData = mapping ? mapping.mapping_data : {};
      const isActive = mapping ? mapping.active : true;
      const sortOrder = mapping ? mapping.sort_order : index;

      // Contenedor principal del mapping
      const mappingDiv = document.createElement('div');
      mappingDiv.className = 'bg-slate-700 rounded p-4 mb-2';
      mappingDiv.setAttribute('data-mapping-key', value);

      // Contenedor flex principal
      const flexDiv = document.createElement('div');
      flexDiv.className = 'flex justify-between items-start mb-3';

      // Columna izquierda
      const leftCol = document.createElement('div');
      leftCol.className = 'flex-1';

      // Label input
      const labelContainer = document.createElement('div');
      labelContainer.className = 'mb-2';
      const labelLabel = document.createElement('label');
      labelLabel.className = 'block text-xs text-slate-400 mb-1';
      const labelSpan = document.createElement('span');
      labelSpan.className = 'text-red-400';
      labelSpan.textContent = '*';
      labelLabel.appendChild(document.createTextNode('Label (humano) '));
      labelLabel.appendChild(labelSpan);
      labelContainer.appendChild(labelLabel);
      const labelInput = document.createElement('input');
      labelInput.type = 'text';
      labelInput.id = `mappingLabel_${value}`;
      labelInput.value = mappingLabel;
      labelInput.className = 'w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500';
      labelInput.placeholder = 'Etiqueta legible';
      labelInput.onblur = () => guardarMapping(mappingId || 'new', contextKey, value);
      labelContainer.appendChild(labelInput);
      leftCol.appendChild(labelContainer);

      // Description textarea
      const descContainer = document.createElement('div');
      descContainer.className = 'mb-2';
      const descLabel = document.createElement('label');
      descLabel.className = 'block text-xs text-slate-400 mb-1';
      descLabel.textContent = 'Descripci√≥n';
      descContainer.appendChild(descLabel);
      const descTextarea = document.createElement('textarea');
      descTextarea.id = `mappingDescription_${value}`;
      descTextarea.rows = 2;
      descTextarea.className = 'w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm';
      descTextarea.placeholder = 'Descripci√≥n opcional del mapping';
      descTextarea.value = mappingDescription;
      descTextarea.onblur = () => guardarMapping(mappingId || 'new', contextKey, value);
      descContainer.appendChild(descTextarea);
      leftCol.appendChild(descContainer);

      // Code con contextKey.value
      const codeContainer = document.createElement('div');
      codeContainer.className = 'text-xs text-slate-500 mb-2';
      const codeEl = document.createElement('code');
      codeEl.className = 'text-slate-400';
      codeEl.textContent = `${contextKey}.${value}`;
      codeContainer.appendChild(codeEl);
      leftCol.appendChild(codeContainer);

      flexDiv.appendChild(leftCol);

      // Columna derecha (controles)
      const rightCol = document.createElement('div');
      rightCol.className = 'flex flex-col gap-2 ml-4';

      // Checkbox activo
      const activeLabel = document.createElement('label');
      activeLabel.className = 'flex items-center gap-2 text-sm text-slate-300';
      const activeCheckbox = document.createElement('input');
      activeCheckbox.type = 'checkbox';
      activeCheckbox.checked = isActive;
      activeCheckbox.disabled = !mappingId;
      activeCheckbox.onchange = () => toggleMappingActive(mappingId || 'new', contextKey, value, activeCheckbox.checked);
      activeLabel.appendChild(activeCheckbox);
      const activeSpan = document.createElement('span');
      activeSpan.className = 'text-xs';
      activeSpan.textContent = 'Activo';
      activeLabel.appendChild(activeSpan);
      rightCol.appendChild(activeLabel);

      // Input sort order
      const sortInput = document.createElement('input');
      sortInput.type = 'number';
      sortInput.id = `sortOrder_${value}`;
      sortInput.value = sortOrder;
      sortInput.className = 'w-16 px-2 py-1 bg-slate-800 border border-slate-600 rounded text-white text-xs';
      sortInput.placeholder = 'Orden';
      sortInput.onblur = () => guardarMapping(mappingId || 'new', contextKey, value);
      rightCol.appendChild(sortInput);

      const sortLabel = document.createElement('span');
      sortLabel.className = 'text-xs text-slate-500 text-center';
      sortLabel.textContent = 'Orden';
      rightCol.appendChild(sortLabel);

      // Bot√≥n eliminar (solo si existe mapping)
      if (mappingId) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded';
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.onclick = () => eliminarMapping(mappingId);
        rightCol.appendChild(deleteBtn);
      }

      flexDiv.appendChild(rightCol);
      mappingDiv.appendChild(flexDiv);

      // Details para mapping data (avanzado)
      const details = document.createElement('details');
      details.className = 'mt-2';
      const summary = document.createElement('summary');
      summary.className = 'cursor-pointer text-sm text-slate-400 hover:text-slate-300 mb-2';
      summary.textContent = '‚öôÔ∏è Mapping Data (JSON avanzado)';
      details.appendChild(summary);
      const detailsDiv = document.createElement('div');
      detailsDiv.className = 'mt-2';
      const dataLabel = document.createElement('label');
      dataLabel.className = 'block text-xs text-slate-400 mb-1';
      dataLabel.textContent = 'Mapping Data (JSON)';
      detailsDiv.appendChild(dataLabel);
      const dataTextarea = document.createElement('textarea');
      dataTextarea.id = `mappingData_${value}`;
      dataTextarea.rows = 4;
      dataTextarea.className = 'w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-xs';
      dataTextarea.placeholder = '{"max_aspects": 5, "minutes": 10}';
      dataTextarea.value = JSON.stringify(mappingData, null, 2);
      dataTextarea.onblur = () => guardarMapping(mappingId || 'new', contextKey, value);
      detailsDiv.appendChild(dataTextarea);
      const dataHelp = document.createElement('p');
      dataHelp.className = 'text-xs text-slate-500 mt-1';
      dataHelp.textContent = 'Par√°metros derivados en formato JSON (solo sem√°ntica, NO l√≥gica)';
      detailsDiv.appendChild(dataHelp);
      details.appendChild(detailsDiv);
      mappingDiv.appendChild(details);

      container.appendChild(mappingDiv);
    });

  } catch (error) {
    console.error('Error cargando mappings:', error);
    const errorMsg = document.createElement('p');
    errorMsg.className = 'text-red-400';
    errorMsg.textContent = `Error cargando mappings: ${error.message}`;
    container.appendChild(errorMsg);
  }
}

// Guardar mapping (auto-guardado al perder foco)
async function guardarMapping(mappingId, contextKey, mappingKey) {
  const labelInput = document.getElementById(`mappingLabel_${mappingKey}`);
  const descriptionTextarea = document.getElementById(`mappingDescription_${mappingKey}`);
  const dataTextarea = document.getElementById(`mappingData_${mappingKey}`);
  const sortOrderInput = document.getElementById(`sortOrder_${mappingKey}`);
  
  if (!labelInput || !sortOrderInput) return;

  const label = labelInput.value.trim();
  if (!label) {
    alert(`El label es obligatorio para el mapping '${mappingKey}'`);
    labelInput.focus();
    return;
  }

  const description = descriptionTextarea ? descriptionTextarea.value.trim() : null;

  let mappingData = {};
  if (dataTextarea && dataTextarea.value.trim()) {
    try {
      mappingData = JSON.parse(dataTextarea.value);
    } catch (e) {
      alert(`JSON inv√°lido en mapping '${mappingKey}': ${e.message}`);
      return;
    }
  }

  const sortOrder = parseInt(sortOrderInput.value) || 0;

  try {
    const response = await fetch('/admin/api/context-mappings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        context_key: contextKey,
        mapping_key: mappingKey,
        label: label,
        description: description,
        mapping_data: mappingData,
        sort_order: sortOrder,
        active: true
      })
    });

    // Leer primero como texto
    const responseText = await response.text();
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error('Error: Respuesta del servidor no es JSON v√°lido');
      console.error('Status:', response.status);
      console.error('Respuesta recibida:', responseText.substring(0, 500));
      alert(`Error: El servidor devolvi√≥ una respuesta inv√°lida. Ver consola.`);
      return;
    }

    if (!data.ok) {
      alert(`Error guardando mapping: ${data.error || 'Error desconocido'}`);
      return;
    }

    // Mostrar warnings si existen
    if (data.warnings && data.warnings.length > 0) {
      console.warn('Warnings al guardar mapping:', data.warnings);
    }

    // Mostrar feedback visual (toast)
    showMappingToast(`‚úÖ Mapping guardado: ${label}`);

    // Recargar mappings para actualizar IDs
    await cargarMappings();
  } catch (error) {
    console.error('Error guardando mapping:', error);
    alert(`Error guardando mapping: ${error.message}`);
  }
}

// Mostrar toast para feedback de guardado
function showMappingToast(message) {
  let toast = document.getElementById('mapping-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'mapping-toast';
    toast.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      font-size: 0.875rem;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
    `;
    document.body.appendChild(toast);
  }
  
  toast.textContent = message;
  toast.style.opacity = '1';
  toast.style.transform = 'translateY(0)';
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(10px)';
  }, 2000);
}

// Toggle active/inactive
async function toggleMappingActive(mappingId, contextKey, mappingKey, active) {
  if (mappingId === 'new') {
    // Si no existe, crear con datos vac√≠os
    await guardarMapping('new', contextKey, mappingKey);
    // Recargar para obtener el ID
    await cargarMappings();
    // Toggle del nuevo mapping
    const newMapping = document.querySelector(`[data-mapping-key="${mappingKey}"]`);
    if (newMapping) {
      // Buscar el mapping reci√©n creado y actualizar
      const response = await fetch(`/admin/api/context-mappings?context_key=${encodeURIComponent(contextKey)}`);
      const responseText = await response.text();
      let data;
      try {
        data = JSON.parse(responseText);
      } catch (parseError) {
        console.error('Error: Respuesta del servidor no es JSON v√°lido');
        console.error('Respuesta recibida:', responseText.substring(0, 500));
        return;
      }
      const mapping = data.mappings?.find(m => m.mapping_key === mappingKey);
      if (mapping) {
        await updateMappingActive(mapping.id, active);
      }
    }
    return;
  }

  await updateMappingActive(mappingId, active);
}

async function updateMappingActive(mappingId, active) {
  try {
    const response = await fetch(`/admin/api/context-mappings/${mappingId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ active })
    });

    const responseText = await response.text();
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error('Error: Respuesta del servidor no es JSON v√°lido');
      console.error('Status:', response.status);
      console.error('Respuesta recibida:', responseText.substring(0, 500));
      alert('Error: El servidor devolvi√≥ una respuesta inv√°lida. Ver consola.');
      return;
    }

    if (!data.ok) {
      alert(`Error actualizando mapping: ${data.error || 'Error desconocido'}`);
      // Revertir checkbox
      const checkbox = document.querySelector(`input[onchange*="${mappingId}"]`);
      if (checkbox) checkbox.checked = !active;
    }
  } catch (error) {
    console.error('Error actualizando mapping:', error);
    alert(`Error actualizando mapping: ${error.message}`);
  }
}

// Eliminar mapping
async function eliminarMapping(mappingId) {
  if (!confirm('¬øEst√°s seguro de eliminar este mapping?')) {
    return;
  }

  try {
    const response = await fetch(`/admin/api/context-mappings/${mappingId}`, {
      method: 'DELETE'
    });

    const responseText = await response.text();
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error('Error: Respuesta del servidor no es JSON v√°lido');
      console.error('Status:', response.status);
      console.error('Respuesta recibida:', responseText.substring(0, 500));
      alert('Error: El servidor devolvi√≥ una respuesta inv√°lida. Ver consola.');
      return;
    }

    if (!data.ok) {
      alert(`Error eliminando mapping: ${data.error || 'Error desconocido'}`);
      return;
    }

    // Recargar mappings
    await cargarMappings();
  } catch (error) {
    console.error('Error eliminando mapping:', error);
    alert(`Error eliminando mapping: ${error.message}`);
  }
}
</script>

